<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP-40 // RIDDIM LAB</title>
    <style>
        :root {
            --ep-orange: #ff3e00;
            --ep-ivory: #e8e4d9;
            --ep-deep-green: #004f0b; /* Updated to your requested shade */
            --ep-black: #121212;
            --ep-white: #ffffff;
            --ep-border: #bcbaaf;
        }

        body {
            background-color: var(--ep-ivory);
            color: var(--ep-black);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            margin: 0;
        }

        .chassis {
            background: var(--ep-ivory);
            border: 4px solid var(--ep-border);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1);
        }

        h1 {
            background: var(--ep-black);
            color: var(--ep-white);
            padding: 10px;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 3px;
            margin-top: 0;
            border-radius: 2px;
            text-transform: uppercase;
        }

        /* The Lab Display */
        .lcd-display {
            background: #0a0c0a; /* Darker background for the deep green */
            color: var(--ep-deep-green);
            padding: 15px;
            border-radius: 2px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 20px;
            border: 3px inset var(--ep-border);
            height: 110px;
            overflow-y: auto;
            box-shadow: inset 0 0 15px #000;
            line-height: 1.4;
        }

        .section-label {
            font-weight: bold;
            font-size: 0.7rem;
            color: var(--ep-black);
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            border-bottom: 2px solid var(--ep-orange);
            letter-spacing: 1px;
        }

        .panel {
            margin-bottom: 25px;
        }

        /* EP Series Styling for Buttons */
        button {
            background: var(--ep-black);
            color: var(--ep-white);
            border: none;
            padding: 12px;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            border-bottom: 4px solid #000;
            border-radius: 2px;
            transition: all 0.05s;
        }

        button:active {
            transform: translateY(2px);
            border-bottom: 2px solid #000;
        }

        button.primary {
            background: var(--ep-orange);
            border-bottom: 4px solid #b32c00;
        }

        /* Status Colors */
        .connected-state {
            background: var(--ep-deep-green) !important;
            color: var(--ep-white) !important;
            border-bottom-color: #002d06 !important;
        }

        select {
            width: 100%;
            padding: 10px;
            background: var(--ep-white);
            border: 2px solid var(--ep-black);
            font-family: inherit;
            margin-bottom: 10px;
            border-radius: 2px;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--ep-orange);
            margin: 15px 0;
        }

        .panic {
            background: #777;
            font-size: 0.65rem;
            margin-top: 10px;
            border-bottom-color: #444;
        }
    </style>
</head>
<body>

    <div class="chassis">
        <h1>EP-40 PRODUCTION TOOLKIT</h1>
        
        <div class="lcd-display" id="log">
            SYSTEM IDLE...<br>AWAITING USB-C CONNECTION
        </div>

        <div class="panel">
            <span class="section-label">01 // DEVICE CONTROL</span>
            <button onclick="initMIDI()" class="primary" id="init-btn">Initialize Connection</button>
        </div>

        <div class="panel">
            <span class="section-label">02 // AUTO-PROGRAMMER (1 BAR)</span>
            <button onclick="autoProgram()">AUTO-WRITE DRUM BUILD</button>
        </div>

        <div class="panel">
            <span class="section-label">03 // PATTERN INJECTOR</span>
            <select id="pattern-type">
                <option value="dembow">DEMBOW (3+3+2)</option>
                <option value="stepper">STEPPER (4x4)</option>
                <option value="skank">SKANK (OFFBEATS)</option>
            </select>
            <button onclick="injectRiddim()">INJECT LIVE PATTERN</button>
        </div>

        <div class="panel">
            <span class="section-label">04 // ANALOG PERFORMANCE</span>
            <label style="font-size: 0.6rem;">CC 74 : RESONANT FILTER</label>
            <input type="range" id="macro-fader" min="0" max="127" value="64">
        </div>

        <button onclick="panic()" class="panic">Global MIDI Panic</button>
    </div>

    <script>
        let midiOut = null;
        const logDisplay = document.getElementById('log');

        function log(m) {
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            logDisplay.innerHTML += `<div>[${time}] ${m}</div>`;
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        async function initMIDI() {
            try {
                const midi = await navigator.requestMIDIAccess();
                const outputs = Array.from(midi.outputs.values());
                midiOut = outputs.find(o => 
                    o.name.toLowerCase().includes("ep") || 
                    o.name.toLowerCase().includes("sample") ||
                    o.name.toLowerCase().includes("audio")
                );

                if (midiOut) {
                    log(`DEVICE FOUND: ${midiOut.name}`);
                    const btn = document.getElementById('init-btn');
                    btn.innerText = "DEVICE CONNECTED";
                    btn.classList.add('connected-state');
                } else {
                    log("SCANNING: No hardware found. Ensure USB-C is data-ready.");
                }
            } catch (err) {
                log("PERMISSIONS: MIDI Access Denied.");
            }
        }

        function sendNote(note, vel, time) {
            if (!midiOut) return;
            midiOut.send([144, note, vel], time); 
            midiOut.send([128, note, 0], time + 150); 
        }

        async function autoProgram() {
            if (!midiOut) return log("ERR: No Device");
            
            log("AUTO-SEQ: Commencing Build...");
            const bpm = 110;
            const msPerBeat = 60000 / bpm; 
            const now = window.performance.now();

            midiOut.send([0xFA]); // Start

            sendNote(36, 115, now + (msPerBeat * 0)); // Kick 1
            sendNote(37, 105, now + (msPerBeat * 1)); // Snare 2
            sendNote(36, 115, now + (msPerBeat * 2)); // Kick 3
            sendNote(37, 105, now + (msPerBeat * 3)); // Snare 4

            setTimeout(() => {
                midiOut.send([0xFC]); // Stop
                log("AUTO-SEQ: Buffer Written.");
            }, msPerBeat * 4);
        }

        function injectRiddim() {
            if (!midiOut) return log("ERR: No Device");
            const type = document.getElementById('pattern-type').value;
            const now = window.performance.now();
            log(`MSG: Sending ${type.toUpperCase()}`);

            if (type === 'dembow') {
                [0, 375, 750, 1125].forEach(t => sendNote(36, 100, now + t)); 
            } else if (type === 'stepper') {
                [0, 500, 1000, 1500].forEach(t => sendNote(36, 110, now + t));
            } else if (type === 'skank') {
                [250, 750, 1250, 1750].forEach(t => sendNote(48, 90, now + t));
            }
        }

        document.getElementById('macro-fader').oninput = (e) => {
            if (midiOut) midiOut.send([176, 74, e.target.value]);
        };

        function panic() {
            if (midiOut) {
                for(let i=0; i<16; i++) midiOut.send([176, 123, 0]);
            }
            log("LOG: Global Panic Executed.");
        }
    </script>
</body>
</html>
