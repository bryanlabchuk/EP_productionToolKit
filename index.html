<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP // UNIVERSAL TOOLKIT</title>
    <style>
        /* THEME DEFINITIONS */
        :root {
            --bg: linear-gradient(135deg, #d8d4c9 0%, #b1b1b1 33%, #c9b98d 66%, #a1a1a1 100%);
            --accent: #ff3e00; --text: #1a1a1a; --lcd-bg: #080a08; 
            --lcd-text: #39ff14; --border: #8e8e8e; --panel-bg: rgba(255, 255, 255, 0.4);
            --shadow: rgba(0,0,0,0.3);
        }

        body.theme-40 {
            --bg: #f4f1e6; --accent: #ff3e00; --text: #1a1a1a; 
            --lcd-bg: #050a05; --lcd-text: #008f11; --border: #c5c2b7; --panel-bg: #ffffff;
        }

        body.theme-133 {
            --bg: #bcbcbc; --accent: #ff3e00; --text: #000000;
            --lcd-bg: #121212; --lcd-text: #ff4500; --border: #888888; --panel-bg: #e0e0e0;
        }

        body.theme-1320 {
            --bg: #dccb96; --accent: #9b111e; --text: #3d2b1f;
            --lcd-bg: #2e1a0d; --lcd-text: #f3e5ab; --border: #a6894c; --panel-bg: #e6d9ad;
        }

        body {
            background: var(--bg); background-attachment: fixed; color: var(--text);
            font-family: 'Courier New', Courier, monospace; display: flex; 
            flex-direction: column; align-items: center; padding: 40px 20px; margin: 0; 
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .chassis {
            background: var(--bg); border: 2px solid var(--border); border-radius: 8px; 
            padding: 30px; width: 100%; max-width: 500px;
            box-shadow: 20px 20px 60px var(--shadow), -5px -5px 20px rgba(255,255,255,0.2);
        }

        h1 {
            background: var(--text); color: var(--bg); padding: 12px; font-size: 0.9rem; 
            text-align: center; letter-spacing: 4px; margin: -30px -30px 25px -30px; 
            text-transform: uppercase; font-weight: 900;
        }

        .lcd-display {
            background: var(--lcd-bg); color: var(--lcd-text); padding: 15px; 
            border-radius: 4px; font-size: 0.85rem; font-weight: bold; margin-bottom: 25px;
            border: 4px solid #222; height: 90px; overflow-y: auto; 
            box-shadow: inset 0 0 20px #000; text-shadow: 0 0 5px var(--lcd-text);
        }

        .instructions {
            background: var(--panel-bg); border-left: 4px solid var(--accent);
            padding: 15px; font-size: 0.75rem; margin-bottom: 25px; line-height: 1.5;
        }

        .section-label { font-weight: 800; font-size: 0.65rem; color: var(--text); margin-bottom: 12px; display: block; text-transform: uppercase; border-bottom: 1px solid var(--accent); }

        .panel { margin-bottom: 20px; border-top: 1px solid rgba(0,0,0,0.1); padding: 15px 0; }

        button {
            background: var(--text); color: var(--bg); border: none; padding: 14px; 
            font-family: inherit; font-weight: bold; text-transform: uppercase; 
            cursor: pointer; width: 100%; border-radius: 4px; box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: all 0.1s;
        }

        button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        button.primary { background: var(--accent); color: white; }

        select, input { width: 100%; padding: 10px; background: rgba(0,0,0,0.05); border: 1px solid var(--text); font-family: inherit; border-radius: 4px; margin-bottom: 10px; }

        .pad-map { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 15px; }
        .pad-box { background: rgba(0,0,0,0.08); font-size: 0.55rem; text-align: center; padding: 6px; border-radius: 2px; }
    </style>
</head>
<body id="main-body">

<div class="chassis">
    <h1 id="main-header">EP // UNIVERSAL TOOLKIT</h1>
    <div class="lcd-display" id="log">AWAITING DEVICE...<br>BOOTING EP_LAB INTERFACE V3.2</div>

    <div class="instructions">
        <strong>OPERATION:</strong> Set hardware to BPM / BARS (REC+PLAY). Match settings and click INJECT on the first downbeat.
        <div class="pad-map">
            <div class="pad-box">9:B2</div><div class="pad-box">10:S2</div><div class="pad-box">11:OH</div><div class="pad-box">12:PR</div>
            <div class="pad-box">5:MT</div><div class="pad-box">6:ST</div><div class="pad-box">7:RD</div><div class="pad-box">8:CR</div>
            <div class="pad-box">1:B1</div><div class="pad-box">2:S1</div><div class="pad-box">3:HH</div><div class="pad-box">4:LT</div>
        </div>
    </div>

    <div class="panel"><button onclick="initMIDI()" class="primary" id="init-btn">Initialize Hardware</button></div>

    <div class="panel">
        <span class="section-label">Config // BPM & Length</span>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label style="font-size:0.6rem;">TEMPO</label><input type="number" id="tempo" value="120"></div>
            <div><label style="font-size:0.6rem;">BARS</label>
                <select id="bars"><option value="1">1 Bar</option><option value="2">2 Bars</option><option value="4">4 Bars</option><option value="8">8 Bars</option></select>
            </div>
        </div>
    </div>

    <div class="panel">
        <span class="section-label">Foundation // Core Rhythms</span>
        <select id="core-pattern">
            <optgroup label="REGGAE/DANCEHALL">
                <option value="dembow">Dembow (3+3+2)</option>
                <option value="one_drop">One Drop Reggae</option>
                <option value="steely">Steely & Clevie</option>
            </optgroup>
            <optgroup label="HIP-HOP/FUNK">
                <option value="boom_bap">Boom Bap Classic</option>
                <option value="dilla">Dilla Wonky Swing</option>
                <option value="stepper">Classic Stepper</option>
            </optgroup>
            <optgroup label="ELECTRONIC">
                <option value="four_floor">House (4x4)</option>
                <option value="uk_garage">2-Step Garage</option>
                <option value="jungle_kick">Jungle Foundation</option>
            </optgroup>
            <option value="none">-- NO CORE --</option>
        </select>
    </div>

    <div class="panel">
        <span class="section-label">Embellish // Top Layers</span>
        <select id="top-pattern">
            <optgroup label="REGGAE/DANCEHALL">
                <option value="shuffler">Dancehall Shuffler</option>
                <option value="afrobeat">Afro-Percussion</option>
            </optgroup>
            <optgroup label="HIP-HOP/FUNK">
                <option value="straight_8">8th Note Hats</option>
                <option value="straight_16">16th Note Hats</option>
                <option value="triplet">Hi-Hat Triplets</option>
            </optgroup>
            <optgroup label="ELECTRONIC">
                <option value="offbeat_hat">Offbeat House Hats</option>
                <option value="perc_chaos">Breakbeat Toms</option>
                <option value="rim_shot">UKG Rimshots</option>
            </optgroup>
            <option value="none">-- NO TOP --</option>
        </select>
        
        <div style="display: flex; gap: 12px; margin-top: 15px;">
            <button onclick="runSession()" class="primary" style="flex: 2;">Inject Riddim</button>
            <button onclick="stopSession()" style="flex: 1; background: #333;">Stop</button>
        </div>
    </div>

    <button onclick="panic()" style="background:#555; font-size: 0.6rem; border-bottom: none; margin-top: 10px;">Global Reset</button>
</div>

<script>
    let midiOut = null;
    let isPlaying = false; // The Circuit Breaker Flag
    const logEl = document.getElementById('log');

    const PAD = { KICK: 36, SNARE: 37, HAT: 38, LTOM: 39, MTOM: 40, STOM: 41, RIDE: 42, CRASH: 43, KICK2: 44, SNARE2: 45, OHAT: 46, PERC: 47 };

    function log(m) { logEl.innerHTML += `<div>> ${m}</div>`; logEl.scrollTop = logEl.scrollHeight; }

    async function initMIDI() {
        try {
            const midi = await navigator.requestMIDIAccess();
            midiOut = Array.from(midi.outputs.values()).find(o => o.name.toLowerCase().includes("ep") || o.name.toLowerCase().includes("sample"));
            if (midiOut) {
                const name = midiOut.name.toLowerCase();
                const body = document.getElementById('main-body');
                const header = document.getElementById('main-header');
                if (name.includes("1320")) body.className = "theme-1320";
                else if (name.includes("133")) body.className = "theme-133";
                else body.className = "theme-40";
                document.getElementById('init-btn').innerText = "DEVICE SYNCED";
                log("CONNECTED: " + midiOut.name);
            }
        } catch(e) { log("ERR: MIDI Access Denied."); }
    }

    // THE CORE FIX: Note sending now checks the isPlaying flag
    function sendNote(note, vel, timeOffset) {
        if (!midiOut || !isPlaying) return;
        
        const now = window.performance.now();
        const scheduledTime = now + timeOffset;

        midiOut.send([144, note, vel], scheduledTime);
        midiOut.send([128, note, 0], scheduledTime + 100);
    }

    const FOUNDATIONS = {
        dembow: (off, ms) => { [0, ms*0.75, ms*1.5, ms*2.25, ms*3, ms*3.75].forEach(t => sendNote(PAD.KICK, 110, off + t)); [ms, ms*3].forEach(t => sendNote(PAD.SNARE, 105, off + t)); },
        one_drop: (off, ms) => { [ms, ms*3].forEach(t => { sendNote(PAD.KICK, 110, off + t); sendNote(PAD.SNARE, 105, off + t); }); },
        steely: (off, ms) => { [0, ms*1.5, ms*2].forEach(t => sendNote(PAD.KICK, 110, off + t)); [ms, ms*2.5, ms*3.5].forEach(t => sendNote(PAD.SNARE, 100, off + t)); },
        boom_bap: (off, ms) => { [0, ms*1.2, ms*2, ms*2.1].forEach(t => sendNote(PAD.KICK, 115, off + t)); [ms, ms*3].forEach(t => sendNote(PAD.SNARE, 105, off + t)); },
        dilla: (off, ms) => { [0, ms*0.9, ms*1.8, ms*2].forEach(t => sendNote(PAD.KICK, 110, off + t)); [ms*1.1, ms*3.1].forEach(t => sendNote(PAD.SNARE, 95, off + t)); },
        four_floor: (off, ms) => { [0, ms, ms*2, ms*3].forEach(t => sendNote(PAD.KICK, 115, off + t)); [ms, ms*3].forEach(t => sendNote(PAD.SNARE, 100, off + t)); },
        uk_garage: (off, ms) => { [0, ms*1.5].forEach(t => sendNote(PAD.KICK, 115, off + t)); [ms, ms*3].forEach(t => sendNote(PAD.SNARE, 105, off + t)); },
        jungle_kick: (off, ms) => { [0, ms*1.25, ms*2.5].forEach(t => sendNote(PAD.KICK, 115, off + t)); [ms, ms*3].forEach(t => sendNote(PAD.SNARE, 105, off + t)); },
        stepper: (off, ms) => { [0, ms, ms*2, ms*3].forEach(t => sendNote(PAD.KICK, 115, off + t)); [ms, ms*3].forEach(t => sendNote(PAD.SNARE, 105, off + t)); }
    };

    const EMBELLISHMENTS = {
        straight_8: (off, ms) => { [0, ms*0.5, ms, ms*1.5, ms*2, ms*2.5, ms*3, ms*3.5].forEach(t => sendNote(PAD.HAT, 85, off + t)); },
        straight_16: (off, ms) => { for(let i=0; i<16; i++) sendNote(PAD.HAT, 70, off + (i * ms * 0.25)); },
        triplet: (off, ms) => { for(let i=0; i<12; i++) sendNote(PAD.HAT, 90, off + (i * ms * 0.33)); },
        shuffler: (off, ms) => { [ms*0.33, ms*1.33, ms*2.33, ms*3.33].forEach(t => sendNote(PAD.PERC, 90, off + t)); },
        perc_chaos: (off, ms) => { [ms*0.2, ms*1.4, ms*2.6, ms*3.8].forEach((t, i) => sendNote(PAD.LTOM + (i%3), 85, off + t)); },
        rim_shot: (off, ms) => { [ms*0.75, ms*2.25, ms*3.75].forEach(t => sendNote(PAD.SNARE2, 80, off + t)); },
        offbeat_hat: (off, ms) => { [ms*0.5, ms*1.5, ms*2.5, ms*3.5].forEach(t => sendNote(PAD.HAT, 100, off + t)); },
        afrobeat: (off, ms) => { [ms*0.5, ms*1.25, ms*2.5, ms*3.75].forEach(t => sendNote(PAD.PERC, 95, off + t)); }
    };

    function runSession() {
        if (!midiOut) return log("ERR: Connect Hardware");
        
        isPlaying = true;
        const bpm = parseInt(document.getElementById('tempo').value);
        const msPerBeat = 60000 / bpm;
        const bars = parseInt(document.getElementById('bars').value);
        const core = document.getElementById('core-pattern').value;
        const top = document.getElementById('top-pattern').value;

        log(`INJECTING ${bars} BARS...`);
        midiOut.send([0xFA]); // Hardware Start

        for (let bar = 0; bar < bars; bar++) {
            const barOffset = (bar * msPerBeat * 4);
            if (FOUNDATIONS[core]) FOUNDATIONS[core](barOffset, msPerBeat);
            if (EMBELLISHMENTS[top]) EMBELLISHMENTS[top](barOffset, msPerBeat);
        }
    }

    function stopSession() {
        isPlaying = false; // Trigger the circuit breaker
        if (midiOut) {
            midiOut.send([0xFC]); // Hardware Stop
            for(let i=0; i<16; i++) midiOut.send([176, 123, 0]); // Kill ringing notes
        }
        log("STOPPED: Notes and Clock halted.");
    }

    function panic() {
        isPlaying = false;
        if (midiOut) for(let i=0; i<16; i++) midiOut.send([176, 123, 0]);
        log("RESET: All signals cleared.");
    }
</script>
</body>
</html>
