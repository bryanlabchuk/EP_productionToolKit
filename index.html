<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FXBQBXFW44"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FXBQBXFW44');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EP-DC-OXO // REFACTORED</title>
  
  <style>
    /* --- THEME ENGINE --- */
    :root {
      --bg: linear-gradient(135deg, #d8d4c9 0%, #b1b1b1 33%, #c9b98d 66%, #a1a1a1 100%);
      --accent: #ff3e00; 
      --ghost: rgba(255, 62, 0, 0.25);
      --magic: #8a2be2; 
      --text: #1a1a1a; 
      --lcd-bg: #080a08; --lcd-text: #39ff14; 
      --border: #8e8e8e; --panel-bg: rgba(255, 255, 255, 0.45);
      --key-white: #f0f0f0; --key-black: #2a2a2a;
    }

    body.theme-40 { --bg: #f4f1e6; --accent: #006633; --ghost: rgba(0, 102, 51, 0.3); --text: #1a1a1a; --lcd-bg: #050a05; --lcd-text: #008f11; --border: #c5c2b7; --panel-bg: #ffffff; }
    body.theme-133 { --bg: #bcbcbc; --accent: #ff3e00; --ghost: rgba(255, 62, 0, 0.3); --text: #000000; --lcd-bg: #121212; --lcd-text: #ff4500; --border: #888888; --panel-bg: #e0e0e0; }
    body.theme-1320 { --bg: #dccb96; --accent: #9b111e; --ghost: rgba(155, 17, 30, 0.3); --text: #3d2b1f; --lcd-bg: #2e1a0d; --lcd-text: #f3e5ab; --border: #a6894c; --panel-bg: #e6d9ad; }
    
    body.dark-mode {
      --bg: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
      --text: #e0e0e0; --border: #444; --panel-bg: rgba(30,30,30,0.9); 
      --magic: #bd7bf0; --key-white: #aaa; --key-black: #000;
    }

    /* --- LAYOUT STRUCTURE --- */
    body {
      background: var(--bg); background-attachment: fixed; color: var(--text);
      font-family: 'IBM Plex Mono', monospace; 
      display: flex; justify-content: center; align-items: center; 
      min-height: 100vh; margin: 0; 
      box-sizing: border-box;
    }

    .chassis {
      background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px;
      padding: 20px; width: 95%; max-width: 1100px;
      box-shadow: 20px 20px 60px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
      display: flex; flex-direction: column; gap: 15px;
    }
    .chassis.skinny-mode { max-width: 500px; }

    /* HEADER */
    .header-row { display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 1.2rem; letter-spacing: 4px; font-weight: 900; }
    
    /* TERMINAL */
    .lcd-display {
      background: var(--lcd-bg); color: var(--lcd-text); padding: 10px; border-radius: 4px; 
      font-size: 0.75rem; border: 4px solid #222; height: 50px; 
      box-shadow: inset 0 0 20px #000; text-shadow: 0 0 3px var(--lcd-text);
      overflow-y: auto; display: flex; flex-direction: column-reverse;
    }
    .log-entry { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 2px 0; }

    /* MAIN DECK GRID */
    .main-deck { 
      display: grid; 
      grid-template-columns: 1fr 1fr; /* Strict 50/50 Split */
      gap: 20px; 
      align-items: start;
    }
    .chassis.skinny-mode .main-deck { grid-template-columns: 1fr; }

    /* --- PANELS --- */
    .control-group { 
      background: rgba(0,0,0,0.04); padding: 12px; border-radius: 6px; 
      border: 1px solid var(--border); margin-bottom: 15px; 
    }
    
    .editor-panel { 
      background: rgba(0,0,0,0.02); border: 2px solid var(--border); 
      padding: 15px; border-radius: 8px; flex-grow: 1; display:flex; flex-direction:column;
    }

    /* --- UI ELEMENTS --- */
    .btn-main { 
      background: var(--text); color: var(--bg); border: none; padding: 15px; 
      font-weight: 900; cursor: pointer; border-radius: 4px; text-transform: uppercase; 
      border-bottom: 4px solid rgba(0,0,0,0.3); width: 100%; font-family: inherit;
    }
    .btn-main.primary { background: var(--accent); color: white; }
    .btn-main:active { transform: translateY(2px); border-bottom-width: 2px; }

    .btn-small { 
      background: #555; color: white; border: none; padding: 8px; font-size: 0.65rem; 
      cursor: pointer; border-radius: 3px; font-weight: bold; width: 100%; 
      font-family: inherit; transition: background 0.2s; 
    }
    
    .btn-toggle-on { background: var(--lcd-text) !important; color: black !important; border-color: var(--lcd-text) !important; }

    input, select { 
      width: 100%; padding: 6px; background: var(--bg); border: 1px solid var(--text); 
      color: var(--text); font-family: inherit; border-radius: 2px; font-weight: bold; 
      font-size: 0.7rem; box-sizing: border-box; 
    }
    label { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; opacity: 0.8; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }

    /* --- SPECIFIC MODULES --- */
    /* 1. PAD GRID */
    .ep-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .pad-btn { 
      background: rgba(0,0,0,0.05); border: 2px solid var(--border); height: 70px; 
      border-radius: 6px; cursor: pointer; position: relative; box-shadow: 0 3px 0 rgba(0,0,0,0.1); 
    }
    .pad-btn.active-pad { background: var(--accent) !important; border-color: var(--accent); color: white; transform: translateY(1px); }
    .pad-btn.hit { filter: brightness(1.5); transform: translateY(2px); }
    .pad-btn-sq::before { content: ''; position: absolute; top: 10%; left: 10%; width: 15%; height: 15%; background: var(--accent); }
    .active-pad.pad-btn-sq::before { background: white; }
    .legend-tag { position: absolute; top: 5px; right: 8px; font-weight: 900; font-size: 0.8rem; }

    /* 2. GROUP STRIP */
    .group-strip { display: flex; flex-direction: column; gap: 8px; }
    .group-btn { 
      flex: 1; background: rgba(0,0,0,0.1); border: 2px solid var(--text); 
      border-radius: 4px; color: var(--text); font-weight: 900; cursor: pointer; 
      display: flex; align-items: center; justify-content: center;
    }
    .group-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* 3. STEP SEQUENCER */
    .step-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-top: 10px; }
    .step-box { 
      aspect-ratio: 1/1; border: 2px solid var(--text); display: flex; align-items: center; 
      justify-content: center; font-size: 0.8rem; cursor: pointer; font-weight: 900; 
      border-radius: 3px; opacity: 0.6; 
    }
    .step-box.on-x { background: var(--accent); color: white; opacity: 1; border-color: var(--accent); }
    .step-box.on-y { background: #555; color: white; opacity: 1; border-color: #555; }
    .step-box.on-z { color: var(--accent); border-color: var(--accent); border-style: dashed; opacity: 1; }

    /* 4. PIANO */
    .piano-wrapper { display: flex; gap: 4px; height: 90px; margin-bottom: 15px; }
    .piano-side-btn { width: 30px; border: 1px solid var(--text); background: transparent; cursor: pointer; font-weight: bold; color: var(--text); }
    .piano-side-btn.toggle-on { background: var(--text); color: var(--bg); }
    
    .keyboard-frame { flex-grow: 1; position: relative; border: 1px solid var(--text); border-radius: 2px; }
    .keys-container { display: flex; height: 100%; }
    .key-white { flex: 1; background: var(--key-white); border-right: 1px solid var(--border); cursor: pointer; position: relative; z-index: 1; }
    .key-white:last-child { border-right: none; }
    .key-white.is-root { background: var(--accent) !important; }
    .key-white.is-chord { background: var(--ghost); }
    
    .key-black { position: absolute; top: 0; height: 60%; width: 8%; background: var(--key-black); z-index: 2; cursor: pointer; transform: translateX(-50%); border: 1px solid rgba(255,255,255,0.2); }
    .key-black.is-root { background: var(--accent) !important; border-color: var(--bg); }
    .key-black.is-chord { background: var(--ghost); border-color: var(--text); }
    
    /* Key Positions */
    .kb-1 { left: 12.5%; } .kb-3 { left: 25%; } .kb-6 { left: 50%; } 
    .kb-8 { left: 62.5%; } .kb-10 { left: 75%; } .kb-13 { left: 100%; transform: translateX(-100%); width: 6% !important;}

    /* 5. SLIDERS */
    input[type=range].magic-knob::-webkit-slider-thumb { background: var(--magic); border-color: white; }
    .magic-label { color: var(--magic); font-weight: 900; letter-spacing: 1px; }

    /* --- MODALS --- */
    #feedback-btn { position: fixed; bottom: 20px; right: 20px; background: var(--text); color: var(--bg); border: 2px solid var(--border); padding: 10px 20px; font-weight: 900; border-radius: 30px; cursor: pointer; z-index: 100; font-size: 0.75rem; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-box { background: var(--bg); border: 2px solid var(--accent); width: 90%; max-width: 400px; padding: 25px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; }
  </style>
</head>

<body id="main-body">

  <button id="feedback-btn" onclick="openFeedback()">REPORT ISSUE</button>
  
  <div class="modal-overlay" id="feedback-modal">
    <div class="modal-box">
      <strong>SYSTEM REPORT</strong>
      <div><label>TYPE</label><select id="fb-type"><option>BUG</option><option>FEATURE</option></select></div>
      <div><label>DETAILS</label><textarea class="modal-input" id="fb-text"></textarea></div>
      <div style="text-align:right;"><button class="btn-small" style="width:auto;" onclick="closeFeedback()">CLOSE</button> <button class="btn-small primary" style="width:auto;" onclick="submitFeedback()">SEND</button></div>
    </div>
  </div>

  <div class="chassis" id="app-chassis">
    
    <div class="header-row">
      <h1>EP-DC-OXO</h1>
      <div class="header-controls">
        <button class="btn-small" style="width:auto;" onclick="toggleDark()">NIGHT</button>
        <button class="btn-small" style="width:auto;" onclick="toggleLayout()">â¬Œ</button>
      </div>
    </div>
    
    <div class="lcd-display" id="log"><div class="log-entry">SYSTEM READY // CORE v46</div></div>

    <div class="main-deck">
      
      <div class="deck-left">
        <button onclick="initAudioAndMIDI()" class="btn-main primary" id="init-btn" style="margin-bottom:20px;">INITIALIZE MIDI</button>

        <div class="control-group">
          <div class="grid-2" style="margin-bottom:10px;">
            <div><label>BPM</label><input type="number" id="tempo" value="120"></div>
            <div><label>CHANNEL</label><div style="font-size:0.7rem; font-weight:900; padding:6px; background:rgba(0,0,0,0.1); text-align:center;" id="chan-display">AUTO</div></div>
          </div>
          <div class="grid-2" style="margin-bottom:10px;">
            <div><label>LENGTH</label><select id="global-bars"><option value="1">1 Bar</option><option value="2">2 Bars</option><option value="4">4 Bars</option><option value="8">8 Bars</option></select></div>
            <div><label>SWING</label><input type="range" style="width:100%;" id="swing-slider" min="0" max="75" value="0"></div>
          </div>
          <div class="grid-2">
            <button id="human-btn" onclick="toggleHuman()" class="btn-small">HUMAN: OFF</button>
            <button id="transport-btn" onclick="toggleTransport()" class="btn-small btn-toggle-on">TX: START/STOP</button>
          </div>
          <div style="margin-top:10px;"><button id="count-btn" onclick="toggleCountIn()" class="btn-small">COUNT: OFF</button></div>
        </div>

        <div style="display: grid; grid-template-columns: 50px 1fr; gap: 10px; margin-bottom: 20px;">
          <div class="group-strip">
            <button class="group-btn active" id="grp-0" onclick="selectGroup(0)">A</button>
            <button class="group-btn" id="grp-1" onclick="selectGroup(1)">B</button>
            <button class="group-btn" id="grp-2" onclick="selectGroup(2)">C</button>
            <button class="group-btn" id="grp-3" onclick="selectGroup(3)">D</button>
          </div>
          <div class="ep-grid" id="pad-grid"></div>
        </div>

        <div class="control-group">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <strong>PAD SETTINGS</strong>
              <button class="btn-small" style="width:auto; padding:2px 8px;" onclick="resetPadPerf()">RESET</button>
            </div>
            <div class="grid-2">
              <div><label>NOTE</label><input type="number" id="pad-midi-note" min="0" max="127" onchange="updatePadPerfFromUI()"></div>
              <div><label>GATE</label><input type="number" id="pad-gate-ms" min="10" max="2000" onchange="updatePadPerfFromUI()"></div>
              <div><label>VEL MODE</label><select id="pad-vel-mode" onchange="updatePadPerfFromUI()"><option value="xyz">XYZ</option><option value="fixed">Fixed</option><option value="range">Range</option></select></div>
              <div><label>AUTO CC</label><input type="number" id="pad-auto-cc" onchange="updatePadPerfFromUI()"></div>
            </div>
            <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
                <button id="pad-mute-btn" class="btn-small" onclick="togglePadMute()">ACTIVE</button>
                <div style="font-size:0.7rem;">PREVIEW: <span id="pad-note-preview">--</span></div>
            </div>
            <input type="hidden" id="pad-vel-a"><input type="hidden" id="pad-vel-b">
        </div>
      </div>

      <div class="deck-right">
        <div class="editor-panel">
          <div class="editor-header">
            <strong>COMPOSER</strong>
            <div>
              <button id="pad-mode-drum" onclick="setPadMode('drum')" class="btn-small btn-toggle-on" style="width:auto;">DRUM</button>
              <button id="pad-mode-chord" onclick="setPadMode('chord')" class="btn-small" style="width:auto;">CHORD</button>
            </div>
          </div>

          <div id="chord-lab" style="display:none; margin-bottom:15px;">
            <div class="piano-wrapper">
                <button class="piano-side-btn" onclick="shiftOctave(-1)">&lt;</button>
                <div class="keyboard-frame">
                    <div class="keys-container" id="white-keys">
                        <div class="key-white" data-note="0"></div><div class="key-white" data-note="2"></div>
                        <div class="key-white" data-note="4"></div><div class="key-white" data-note="5"></div>
                        <div class="key-white" data-note="7"></div><div class="key-white" data-note="9"></div>
                        <div class="key-white" data-note="11"></div><div class="key-white" data-note="12" style="border-right:none;"></div> 
                    </div>
                    <div class="key-black kb-1" data-note="1"></div><div class="key-black kb-3" data-note="3"></div>
                    <div class="key-black kb-6" data-note="6"></div><div class="key-black kb-8" data-note="8"></div>
                    <div class="key-black kb-10" data-note="10"></div><div class="key-black kb-13" data-note="13"></div>
                </div>
                <button class="piano-side-btn" onclick="shiftOctave(1)">&gt;</button>
                <button class="piano-side-btn" id="audition-toggle" onclick="toggleAudition()">ðŸ”ˆ</button>
            </div>
            
            <div class="grid-2">
                <div style="display:none;"><select id="chord-root" onchange="updateChordSettings()"><option value="0">C</option><option value="1">C#</option><option value="2">D</option><option value="3">D#</option><option value="4">E</option><option value="5">F</option><option value="6">F#</option><option value="7">G</option><option value="8">G#</option><option value="9">A</option><option value="10">A#</option><option value="11">B</option></select></div>
                <div style="display:none;"><select id="chord-oct" onchange="updateChordSettings()"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select></div>
                
                <div><label>QUALITY</label><select id="chord-quality" onchange="updateChordSettings()"><option value="maj">Major</option><option value="min">Minor</option><option value="dom">Dominant</option><option value="dim">Diminished</option><option value="aug">Augmented</option><option value="sus2">Sus 2</option><option value="sus4">Sus 4</option></select></div>
                <div><label>EXT</label><select id="chord-ext" onchange="updateChordSettings()"><option value="none">Triad</option><option value="7">7th</option><option value="9">9th</option><option value="11">11th</option><option value="6">6th</option></select></div>
                <div><label>INV</label><select id="chord-inv" onchange="updateChordSettings()"><option value="0">Root</option><option value="1">1st</option><option value="2">2nd</option></select></div>
                <div><label>VOICE</label><select id="chord-voice" onchange="updateChordSettings()"><option value="close">Close</option><option value="wide">Wide</option><option value="open">Open</option></select></div>
            </div>
            <div style="margin-top:10px;"><label class="magic-label">FLUX</label><input type="range" style="width:100%;" class="magic-knob" id="chord-flux" min="0" max="100" value="0" oninput="updateChordSettings()"></div>
          </div>

          <div class="grid-2" style="margin-bottom:10px;">
            <div><label>LEN</label><select id="step-select" onchange="updateStepCount(this.value)"><option value="16">16 Steps</option><option value="32">32 Steps</option></select></div>
            <div><label>PATTERNS</label><select id="preset-select" onchange="applyPreset(this.value)"></select></div>
          </div>
          
          <div id="grid-notes" class="step-container"></div>
          <div style="margin-top:10px; text-align:right;"><button class="btn-small" style="width:auto;" onclick="clearCurrentPad()">CLEAR</button></div>
        </div>

        <div class="action-row" style="margin-top:20px;">
            <button onclick="handleInject()" class="btn-main primary" id="inject-btn">INJECT</button>
            <button onclick="stopSequencer()" class="btn-main" style="background:#333; color:#fff;">STOP / PANIC</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    let audioCtx = null;
    let midiOut = null;
    let nextNoteTime = 0.0;
    let timerID = null;
    let current16thNote = 0;
    let isPlaying = false;
    let scheduleAheadTime = 0.1; 
    let selectedPad = 0;
    let activeGroup = 0;
    let humanize = false;
    let countIn = false;
    let sendTransport = true; 
    let auditionMode = false;

    const legends = { 9: '7', 10: '8', 11: '9', 6: '4', 7: '5', 8: '6', 3: '1', 4: '2', 5: '3', 0: '', 1: '0', 2: 'ENTER' };
    const padNotes = [36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47];
    const chordShapes = { 'maj': [0, 4, 7], 'min': [0, 3, 7], 'dim': [0, 3, 6], 'aug': [0, 4, 8], 'sus2': [0, 2, 7], 'sus4': [0, 5, 7] };

    function defaultMidiNoteForPadIndex(padIndex) { return padNotes[padIndex] ?? 36; }

    // INITIAL DATA
    let projectData = Array.from({length: 4}, () => 
        Array.from({length: 12}, (_, p) => ({ 
            steps: 16, notes: Array(32).fill('O'), auto: Array(32).fill(0), 
            autoTargetCC: 74, midiNote: defaultMidiNoteForPadIndex(p), gateMs: 100, velMode: 'xyz', velA: 110, velB: 125, muted: false,
            mode: 'drum', chord: { root:0, oct:3, quality:'maj', ext:'none', inv:0, voice:'close', flux:0 }
        }))
    );

    // PRESETS (Restored)
    const oxoPresets = {
        "KICK": [{ name: "4-Floor", pat: "XOOOXOOOXOOOXOOO" }, { name: "Boom Bap", pat: "XOOZOOXZOOOOXOOO" }],
        "SNARE": [{ name: "Backbeat", pat: "OOOOXOOOOOOOXOOO" }],
        "HATS": [{ name: "16ths", pat: "XXXXXXXXXXXXXXXX" }, { name: "Trap", pat: "XZXZXZXZXXXXXZXZ" }],
        "KITS": [{ name: "House Kit", type: "multi", tracks: { 0:"XOOOXOOOXOOOXOOO", 1:"OOOOXOOOOOOOXOOO", 2:"OOXOOOXOOOXOOOXO" } }]
    };

    /* --- LOGIC --- */
    function getChordIntervals(q, e) {
        let i = [0];
        if(['min','dim'].includes(q)) i.push(3); else if(q=='sus2') i.push(2); else if(q=='sus4') i.push(5); else i.push(4);
        if(q=='dim') i.push(6); else if(q=='aug') i.push(8); else i.push(7);
        if(e!=='none') {
            let s = (q=='maj'||q=='aug')?11:10; if(q=='dim') s=9; i.push(s);
            if(['9','11','13'].includes(e)) i.push(14);
            if(['11','13'].includes(e)) i.push(17);
            if(e=='13') i.push(21);
            if(e=='6') { i.pop(); i.push(9); }
        }
        return i;
    }
    function applyVoicing(i,v) { if(v=='close')return i; let n=[...i]; if(v=='wide'&&n[1])n[1]+=12; if(v=='open'){if(n[1])n[1]+=12;if(n[2])n[2]+=24;} return n; }
    function applyInversion(i,inv) { let n=[...i]; for(let k=0;k<inv;k++) n.push(n.shift()+12); return n; }
    
    function updateVisuals() {
        const c = projectData[activeGroup][selectedPad].chord;
        const r = c.root;
        let iv = getChordIntervals(c.quality, c.ext);
        let n = iv.map(x=>(r+x)%12);
        document.querySelectorAll('.key-white, .key-black').forEach(k => {
            k.classList.remove('is-root','is-chord');
            let v = parseInt(k.getAttribute('data-note'));
            if(v%12===r) k.classList.add('is-root');
            else if(n.includes(v%12)) k.classList.add('is-chord');
        });
    }

    /* --- DOM INTERACTION --- */
    document.addEventListener("DOMContentLoaded", () => {
        const ps = document.getElementById('preset-select');
        let def = document.createElement('option'); def.innerText = "-- SELECT --"; ps.appendChild(def);
        for(const [c,l] of Object.entries(oxoPresets)) {
            const g = document.createElement('optgroup'); g.label = c;
            l.forEach(p => { const o = document.createElement('option'); o.value=JSON.stringify(p); o.innerText=p.name; g.appendChild(o); });
            ps.appendChild(g);
        }
        
        const ge = document.getElementById('pad-grid');
        [9,10,11,6,7,8,3,4,5,0,1,2].forEach(i => {
            const b = document.createElement('div'); b.className = 'pad-btn'+(i===0?' pad-btn-sq':'');
            b.id = `btn-${i}`; b.innerHTML = `<div class="legend-tag">${legends[i]}</div>`;
            b.onclick = () => selectPad(i); ge.appendChild(b);
        });

        document.querySelectorAll('.key-white, .key-black').forEach(k => {
            k.onmousedown = function() {
                const n = parseInt(this.getAttribute('data-note'));
                if(!isNaN(n)) {
                    document.getElementById('chord-root').value = n%12;
                    updateChordSettings();
                    if(auditionMode) previewChord();
                }
            }
        });
        
        selectPad(0);
    });

    function selectPad(idx) {
        selectedPad = idx;
        document.querySelectorAll('.pad-btn').forEach(b => b.classList.remove('active-pad'));
        document.getElementById(`btn-${idx}`).classList.add('active-pad');
        let l = legends[idx]; if(idx===0) l='â– ';
        document.getElementById('editor-title').innerText = `EDIT PAD ${l}`;
        syncPadPerfUI();
        syncChordUI();
        renderSteps();
    }

    function selectGroup(idx) {
        activeGroup = idx;
        document.querySelectorAll('.group-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
        document.getElementById('chan-display').innerText = `GROUP ${['A','B','C','D'][idx]} (CH ${idx+1})`;
        selectPad(selectedPad);
    }

    function setPadMode(m) {
        projectData[activeGroup][selectedPad].mode = m;
        document.getElementById('pad-mode-drum').classList.toggle('btn-toggle-on', m==='drum');
        document.getElementById('pad-mode-chord').classList.toggle('btn-toggle-on', m==='chord');
        document.getElementById('chord-lab').style.display = m==='chord'?'block':'none';
        if(m==='chord') updateVisuals();
    }

    function updateChordSettings() {
        const c = projectData[activeGroup][selectedPad].chord;
        c.root = parseInt(document.getElementById('chord-root').value);
        c.oct = parseInt(document.getElementById('chord-oct').value);
        c.quality = document.getElementById('chord-quality').value;
        c.ext = document.getElementById('chord-ext').value;
        c.inv = parseInt(document.getElementById('chord-inv').value);
        c.voice = document.getElementById('chord-voice').value;
        c.flux = parseInt(document.getElementById('chord-flux').value);
        updateVisuals();
    }

    function syncChordUI() {
        const c = projectData[activeGroup][selectedPad].chord;
        document.getElementById('chord-root').value = c.root;
        document.getElementById('chord-oct').value = c.oct;
        document.getElementById('chord-quality').value = c.quality;
        document.getElementById('chord-ext').value = c.ext;
        document.getElementById('chord-inv').value = c.inv;
        document.getElementById('chord-voice').value = c.voice;
        document.getElementById('chord-flux').value = c.flux;
        setPadMode(projectData[activeGroup][selectedPad].mode);
    }

    function syncPadPerfUI() {
        const p = projectData[activeGroup][selectedPad];
        document.getElementById('pad-midi-note').value = p.midiNote;
        document.getElementById('pad-gate-ms').value = p.gateMs;
        document.getElementById('pad-vel-mode').value = p.velMode;
        document.getElementById('pad-vel-a').value = p.velA;
        document.getElementById('pad-vel-b').value = p.velB;
        document.getElementById('pad-auto-cc').value = p.autoTargetCC;
        document.getElementById('pad-mute-btn').innerText = p.muted ? "MUTED" : "ACTIVE";
        document.getElementById('pad-mute-btn').classList.toggle('btn-toggle-on', !p.muted);
        document.getElementById('pad-note-preview').innerText = p.midiNote;
    }

    function updatePadPerfFromUI() {
        const p = projectData[activeGroup][selectedPad];
        p.midiNote = parseInt(document.getElementById('pad-midi-note').value);
        p.gateMs = parseInt(document.getElementById('pad-gate-ms').value);
        p.velMode = document.getElementById('pad-vel-mode').value;
        p.velA = parseInt(document.getElementById('pad-vel-a').value);
        p.velB = parseInt(document.getElementById('pad-vel-b').value);
        p.autoTargetCC = parseInt(document.getElementById('pad-auto-cc').value);
        document.getElementById('pad-note-preview').innerText = p.midiNote;
    }
    
    function togglePadMute() { const p = projectData[activeGroup][selectedPad]; p.muted = !p.muted; syncPadPerfUI(); }
    function resetPadPerf() { const p = projectData[activeGroup][selectedPad]; p.midiNote=defaultMidiNoteForPadIndex(selectedPad); p.gateMs=100; p.velMode='xyz'; p.velA=110; p.velB=125; p.autoTargetCC=74; p.muted=false; syncPadPerfUI(); }

    function shiftOctave(d) {
        const c = projectData[activeGroup][selectedPad].chord;
        c.oct = Math.max(0, Math.min(8, c.oct + d));
        syncChordUI();
    }
    
    function toggleAudition() { auditionMode = !auditionMode; document.getElementById('audition-toggle').classList.toggle('toggle-on', auditionMode); }

    function previewChord() {
        if(!midiOut) return;
        const d = projectData[activeGroup][selectedPad];
        const chan = activeGroup; 
        const root = (d.chord.oct+1)*12 + d.chord.root;
        let ints = getChordIntervals(d.chord.quality, d.chord.ext);
        ints = applyInversion(ints, d.chord.inv);
        ints = applyVoicing(ints, d.chord.voice);
        ints.forEach((int, i) => {
            midiOut.send([0x90+chan, root+int, 100]);
            midiOut.send([0x80+chan, root+int, 0], performance.now()+400);
        });
    }

    function renderSteps() {
        const c = document.getElementById('grid-notes'); c.innerHTML='';
        const d = projectData[activeGroup][selectedPad];
        for(let i=0; i<d.steps; i++) {
            const b = document.createElement('div');
            const v = d.notes[i];
            b.className = `step-box ${v!=='O'?'on-'+v.toLowerCase():'off'}`;
            b.innerText = v;
            b.onclick = () => { d.notes[i] = ['O','X','Y','Z'][(['O','X','Y','Z'].indexOf(v)+1)%4]; renderSteps(); };
            c.appendChild(b);
        }
    }

    // AUDIO ENGINE (Minified)
    function nextNote(){const b=parseInt(document.getElementById('tempo').value);nextNoteTime+=(0.25*(60.0/b));current16thNote++;}
    function scheduler(){while(nextNoteTime<audioCtx.currentTime+scheduleAheadTime){const t=parseInt(document.getElementById('global-bars').value);if(current16thNote>=t*16){stopSequencer();return;}scheduleNote(current16thNote,nextNoteTime);nextNote();}if(isPlaying)timerID=requestAnimationFrame(scheduler);}
    function scheduleNote(b,t){if(!midiOut)return;
        for(let i=0;i<6;i++)midiOut.send([0xF8],performance.now()+((t+(i*((60.0/parseInt(document.getElementById('tempo').value))*0.25/6)))-audioCtx.currentTime)*1000);
        const swing=parseInt(document.getElementById('swing-slider').value);
        const jt=humanize?(Math.random()*0.015):0;
        const mt=performance.now()+((t+(b%2!==0?((60/parseInt(document.getElementById('tempo').value))/4)*(swing/100):0)+jt)-audioCtx.currentTime)*1000;
        
        for(let g=0;g<4;g++){
            for(let p=0;p<12;p++){
                const d=projectData[g][p]; const s=d.notes[b%d.steps];
                if(d.auto[b%d.steps]>0) midiOut.send([0xB0+g,d.autoTargetCC,d.auto[b%d.steps]],mt);
                if(s!=='O'&&!d.muted){
                    let vel = s==='X'?120:s==='Y'?85:50;
                    if(d.velMode==='fixed') vel=d.velA; else if(d.velMode==='range') vel=d.velA+Math.floor(Math.random()*(d.velB-d.velA));
                    
                    if(d.mode==='chord'){
                        let r=(d.chord.oct+1)*12+d.chord.root;
                        let iv=getChordIntervals(d.chord.quality,d.chord.ext);
                        if(d.chord.flux>0 && Math.random()<(d.chord.flux/100)){ if(Math.random()>0.5)iv.push(19); }
                        iv=applyInversion(iv,d.chord.inv); iv=applyVoicing(iv,d.chord.voice);
                        iv.forEach((int,k)=>{
                            let del=k*(5+(d.chord.flux/100*20));
                            midiOut.send([0x90+g,r+int,vel],mt+del);
                            midiOut.send([0x80+g,r+int,0],mt+del+d.gateMs);
                        });
                    } else {
                        midiOut.send([0x90+g,d.midiNote,vel],mt);
                        midiOut.send([0x80+g,d.midiNote,0],mt+d.gateMs);
                    }
                    if(g===activeGroup) setTimeout(()=>{const el=document.getElementById(`btn-${p}`);if(el){el.classList.add('hit');setTimeout(()=>el.classList.remove('hit'),100)}}, (mt-performance.now()));
                }
            }
        }
    }
    
    function handleInject(){if(!midiOut||!audioCtx)return; if(countIn)runCountIn(); else startSequencer();}
    function runCountIn(){let b=4;const bpm=parseInt(document.getElementById('tempo').value);const i=setInterval(()=>{b--;if(b<=0){clearInterval(i);startSequencer();}else document.getElementById('log').innerHTML=`COUNT: ${b}`},60000/bpm);}
    function startSequencer(){stopSequencer();isPlaying=true;current16thNote=0;nextNoteTime=audioCtx.currentTime+0.1;if(sendTransport)midiOut.send([0xFA]);scheduler();document.getElementById('log').innerHTML="<div class='log-entry'>ROLLING...</div>";}
    function stopSequencer(){isPlaying=false;if(timerID)cancelAnimationFrame(timerID);if(midiOut){if(sendTransport)midiOut.send([0xFC]);midiOut.send([0xB0+activeGroup,123,0]);}document.getElementById('log').innerHTML="<div class='log-entry'>HALTED</div>";}
    
    async function initAudioAndMIDI(){try{if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')await audioCtx.resume();const m=await navigator.requestMIDIAccess();midiOut=Array.from(m.outputs.values()).find(o=>o.name.toLowerCase().includes("ep")||o.name.toLowerCase().includes("sample"));if(midiOut){const n=midiOut.name.toLowerCase();document.body.className=n.includes("1320")?"theme-1320":n.includes("133")?"theme-133":"theme-40";document.getElementById('init-btn').innerText="LINKED";}}catch(e){console.log(e)}}
    
    // UI Helpers
    function toggleDark(){document.body.classList.toggle('dark-mode'); localStorage.setItem('oxo_dark',document.body.classList.contains('dark-mode'));}
    function toggleLayout(){document.getElementById('app-chassis').classList.toggle('skinny-mode');}
    function toggleHuman(){humanize=!humanize;document.getElementById('human-btn').classList.toggle('btn-toggle-on',humanize);}
    function toggleCountIn(){countIn=!countIn;document.getElementById('count-btn').classList.toggle('btn-toggle-on',countIn);}
    function toggleTransport(){sendTransport=!sendTransport;document.getElementById('transport-btn').classList.toggle('btn-toggle-on',sendTransport);document.getElementById('transport-btn').innerText=`TX: ${sendTransport?'START/STOP':'CLOCK ONLY'}`;}
    function openFeedback(){document.getElementById('feedback-modal').style.display='flex';}
    function closeFeedback(){document.getElementById('feedback-modal').style.display='none';}
    function submitFeedback(){const t=document.getElementById('fb-type').value,m=document.getElementById('fb-text').value;window.open(`mailto:bryan.labchuk@gmail.com?subject=EP-DC-OXO Feedback: ${t}&body=${m}`);closeFeedback();}
    function applyPreset(v){if(!v||v.startsWith("-"))return;const p=JSON.parse(v);if(p.type==="multi"){for(const[i,s]of Object.entries(p.tracks))for(let j=0;j<32;j++)projectData[activeGroup][i].notes[j]=s[j%s.length]||'O';}else{const s=p.pat.replace(/\s/g,'');for(let j=0;j<32;j++)projectData[activeGroup][selectedPad].notes[j]=s[j%s.length]||'O';}renderSteps();document.getElementById('preset-select').selectedIndex=0;}
    function clearCurrentPad(){projectData[activeGroup][selectedPad].notes.fill('O');renderSteps();}
    function updateStepCount(v){projectData[activeGroup][selectedPad].steps=parseInt(v);renderSteps();}
  </script>
</body>
</html>
