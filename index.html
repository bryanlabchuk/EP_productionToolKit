<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP-DC-OXO // DRUM COMPUTER</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #d8d4c9 0%, #b1b1b1 33%, #c9b98d 66%, #a1a1a1 100%);
            --accent: #ff3e00; --text: #1a1a1a; --lcd-bg: #080a08; 
            --lcd-text: #39ff14; --border: #8e8e8e; --panel-bg: rgba(255, 255, 255, 0.6);
        }

        body.theme-40 { --bg: #f4f1e6; --accent: #ff3e00; --text: #1a1a1a; --lcd-bg: #050a05; --lcd-text: #008f11; --border: #c5c2b7; --panel-bg: #ffffff; }
        body.theme-133 { --bg: #bcbcbc; --accent: #ff3e00; --text: #000000; --lcd-bg: #121212; --lcd-text: #ff4500; --border: #888888; --panel-bg: #e0e0e0; }
        body.theme-1320 { --bg: #dccb96; --accent: #9b111e; --text: #3d2b1f; --lcd-bg: #2e1a0d; --lcd-text: #f3e5ab; --border: #a6894c; --panel-bg: #e6d9ad; }

        body {
            background: var(--bg); background-attachment: fixed; color: var(--text);
            font-family: 'IBM Plex Mono', 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center;
            padding: 40px 20px; margin: 0; transition: all 0.6s ease;
        }

        .chassis {
            background: var(--bg); border: 2px solid var(--border); border-radius: 12px;
            padding: 30px; width: 100%; max-width: 720px;
            box-shadow: 20px 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            background: var(--text); color: var(--bg);
            padding: 15px; font-size: 1.2rem; text-align: center;
            letter-spacing: 5px; margin: -30px -30px 25px -30px; 
            text-transform: uppercase; font-weight: 900; border-radius: 8px 8px 0 0;
        }

        /* 4x3 Pad Grid Mirroring the EP Hardware */
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px; }
        .pad-btn { 
            background: var(--panel-bg); border: 2px solid var(--border); 
            height: 80px; border-radius: 6px; cursor: pointer; 
            position: relative; display: flex; align-items: center; justify-content: center;
            transition: 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        
        /* The Legend Label */
        .pad-legend { position: absolute; top: 5px; right: 8px; font-size: 0.7rem; font-weight: 900; opacity: 0.8; }
        .pad-desc { font-size: 0.6rem; margin-top: 15px; font-weight: bold; text-transform: uppercase; opacity: 0.6; }
        
        /* Special Case: Pad 1 Square */
        .orange-sq { width: 8px; height: 8px; background: var(--accent); display: inline-block; }

        .pad-btn.active-pad { border-color: var(--accent); background: var(--accent); color: white; transform: translateY(-2px); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .active-pad .pad-legend, .active-pad .pad-desc { opacity: 1; color: white; }

        .editor-panel { background: var(--panel-bg); border: 2px solid var(--accent); padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .step-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-top: 15px; }
        .step-box { aspect-ratio: 1 / 1; background: rgba(0,0,0,0.05); border: 2px solid var(--text); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; font-weight: 900; border-radius: 4px; }
        .step-box.on-x { background: var(--accent); color: white; border-color: var(--accent); }
        .step-box.on-y { background: #555; color: white; border-color: #555; }
        .step-box.on-z { background: transparent; color: var(--accent); border-color: var(--accent); border-style: dashed; }
        .step-box.off { color: var(--text); opacity: 0.4; }

        .config-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; margin-bottom: 20px; align-items: end; }
        button { background: var(--text); color: var(--bg); border: none; padding: 15px; font-weight: bold; cursor: pointer; border-radius: 4px; flex: 1; text-transform: uppercase; border-bottom: 4px solid rgba(0,0,0,0.3); }
        button.primary { background: var(--accent); color: white; }
    </style>
</head>
<body id="main-body">

<div class="chassis">
    <h1>EP-DC-OXO // DRUM COMPUTER</h1>
    <div class="panel" style="margin-bottom: 20px;"><button onclick="initMIDI()" class="primary" id="init-btn">INITIALIZE CONNECTION</button></div>

    <div class="config-row">
        <div><label>BPM</label><input type="number" id="tempo" value="120"></div>
        <div><label>BARS</label><select id="global-bars"><option value="1">1</option><option value="2">2</option><option value="4">4</option></select></div>
        <div><label>FEEL</label><button id="human-btn" onclick="toggleHuman()" style="font-size:0.5rem;">HUMAN: OFF</button></div>
    </div>

    <div class="ep-grid" id="pad-grid"></div>

    <div class="editor-panel" id="editor" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><strong id="editor-title">PAD</strong><span style="font-size: 0.7rem;">OXO STEP EDITOR</span></div>
        <div class="config-row">
            <div><label>STEPS</label><select id="step-select" onchange="updateStepCount(this.value)"><option value="8">8</option><option value="16" selected>16</option><option value="32">32</option></select></div>
            <div><label>OXO PRESET</label><select id="preset-select" onchange="applyPreset(this.value)"></select></div>
        </div>
        <div class="step-container" id="step-ui"></div>
    </div>

    <div class="transport">
        <button onclick="startSequencer()" class="primary" style="flex: 2;">INJECT OXO</button>
        <button onclick="stopSequencer()" style="background: #333;">STOP</button>
    </div>
</div>

<script>
    let midiOut = null;
    let selectedPad = 0;
    
    // Legends mapping based on your request
    const legends = [
        '<div class="orange-sq"></div>', '0', 'ENTER', '1', 
        '2', '3', '4', '5', 
        '6', '7', '8', '9'
    ];
    const padNames = ["Bass 1", "Snare 1", "Hi-Hat", "L-Tom", "M-Tom", "S-Tom", "Ride", "Crash", "Bass 2", "Snare 2", "Open Hat", "Perc"];
    const padNotes = [36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47];
    
    let sequencerData = Array.from({length: 12}, () => ({ steps: 16, data: Array(32).fill('O') }));

    const gridEl = document.getElementById('pad-grid');
    // Rendering in a 4x3 grid but mapping to the EP's 9-12, 5-8, 1-4 layout
    const visualOrder = [8,9,10,11,4,5,6,7,0,1,2,3]; 
    visualOrder.forEach(idx => {
        const btn = document.createElement('div');
        btn.className = 'pad-btn'; btn.id = `btn-${idx}`;
        btn.innerHTML = `<div class="pad-legend">${legends[idx]}</div><div class="pad-desc">${padNames[idx]}</div>`;
        btn.onclick = () => selectPad(idx); gridEl.appendChild(btn);
    });

    // ... (initMIDI, startSequencer, stopSequencer logic remains the same as previous build) ...

    async function initMIDI() {
        const midi = await navigator.requestMIDIAccess();
        midiOut = Array.from(midi.outputs.values()).find(o => o.name.toLowerCase().includes("ep") || o.name.toLowerCase().includes("sample"));
        if (midiOut) {
            const name = midiOut.name.toLowerCase();
            document.body.className = name.includes("1320") ? "theme-1320" : name.includes("133") ? "theme-133" : "theme-40";
            document.getElementById('init-btn').innerText = "DEVICE SYNCED";
        }
    }

    function selectPad(idx) {
        selectedPad = idx;
        document.querySelectorAll('.pad-btn').forEach(b => b.classList.remove('active-pad'));
        document.getElementById(`btn-${idx}`).classList.add('active-pad');
        document.getElementById('editor').style.display = 'block';
        const displayLegend = legends[idx].includes('orange-sq') ? 'â– ' : legends[idx];
        document.getElementById('editor-title').innerText = `PAD ${displayLegend} [${padNames[idx]}]`;
        renderSteps();
    }

    function renderSteps() {
        const container = document.getElementById('step-ui');
        container.innerHTML = '';
        for (let i = 0; i < sequencerData[selectedPad].steps; i++) {
            const step = document.createElement('div');
            const val = sequencerData[selectedPad].data[i];
            step.className = `step-box ${val !== 'O' ? 'on-' + val.toLowerCase() : 'off'}`;
            step.innerText = val;
            step.onclick = () => {
                const cycle = ['O', 'X', 'Y', 'Z'];
                sequencerData[selectedPad].data[i] = cycle[(cycle.indexOf(val) + 1) % cycle.length];
                renderSteps();
            };
            container.appendChild(step);
        }
    }

    // (Add previous preset/sequencer logic back in here)
</script>
</body>
</html>
