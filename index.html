<!DOCTYPE html>
<html>
<head>
    <title>EP-40 RIDDIM LAB</title>
    <style>
        :root { --ep-orange: #ff3e00; --ep-black: #1a1a1a; --ep-grey: #333; }
        body { background: var(--ep-black); color: white; font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .panel { background: var(--ep-grey); border: 2px solid var(--ep-orange); padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; margin-bottom: 15px; }
        h1 { color: var(--ep-orange); margin-bottom: 5px; font-size: 1.5rem; }
        .status { font-size: 0.8rem; margin-bottom: 20px; color: #00ff00; }
        button { background: var(--ep-orange); color: white; border: none; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; border-radius: 4px; }
        select, input[type="range"] { width: 100%; margin: 10px 0; background: #000; color: var(--ep-orange); border: 1px solid var(--ep-orange); padding: 5px; }
        .log { background: #000; font-size: 10px; padding: 10px; height: 80px; overflow-y: auto; color: #aaa; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <h1>EP-40 // RIDDIM LAB</h1>
    <div id="status" class="status">● WAITING FOR INITIALIZATION</div>

    <div class="panel">
        <button id="init-btn">1. CONNECT HARDWARE</button>
    </div>

    <div class="panel">
        <strong>2. RIDDIM INJECTOR</strong>
        <select id="pattern-type">
            <option value="dembow">DEMBOW (3+3+2)</option>
            <option value="stepper">STEPPER (4-ON-FLOOR)</option>
            <option value="skank">SKANK CHOP (OFFBEATS)</option>
        </select>
        <button id="inject-btn">FIRE PATTERN INTO EP</button>
        <p style="font-size: 10px;">Set EP to Record Mode first!</p>
    </div>

    <div class="panel">
        <strong>3. CHAOS FADER (LPF)</strong>
        <input type="range" id="macro-fader" min="0" max="127" value="64">
    </div>

    <button id="panic-btn" style="background: #555;">! MIDI PANIC (STOP ALL) !</button>

    <div class="log" id="log">System ready...</div>

    <script>
        let midiOut = null;
        const log = (m) => { document.getElementById('log').innerHTML += `<div>> ${m}</div>`; document.getElementById('log').scrollTop = 9999; };

        document.getElementById('init-btn').onclick = async () => {
            const midi = await navigator.requestMIDIAccess();
            const outputs = Array.from(midi.outputs.values());
            midiOut = outputs.find(o => o.name.toLowerCase().includes("ep") || o.name.toLowerCase().includes("sample"));
            if (midiOut) {
                document.getElementById('status').innerText = `● CONNECTED: ${midiOut.name}`;
                log("Hardware Synced.");
            }
        };

        // RIDDIM LOGIC
        document.getElementById('inject-btn').onclick = () => {
            if (!midiOut) return log("Error: Connect Hardware First");
            const type = document.getElementById('pattern-type').value;
            const now = window.performance.now();
            log(`Injecting ${type} pattern...`);

            if (type === 'dembow') {
                const kicks = [0, 375, 750, 1125]; // 3+3+2 feeling at 110bpm approx
                kicks.forEach(t => sendNote(36, 100, now + t)); 
            } else if (type === 'stepper') {
                [0, 500, 1000, 1500].forEach(t => sendNote(36, 110, now + t));
            } else if (type === 'skank') {
                [250, 750, 1250, 1750].forEach(t => sendNote(48, 90, now + t));
            }
        };

        function sendNote(note, vel, time) {
            midiOut.send([144, note, vel], time); // Note On
            midiOut.send([128, note, 0], time + 100); // Note Off
        }

        // NEW: AUTOMATED SEQUENCER LOGIC
document.getElementById('auto-program-btn').onclick = async () => {
    if (!midiOut) return log("Connect Hardware First");
    
    log("Starting Auto-Program...");
    const bpm = 110;
    const msPerBeat = 60000 / bpm; // ~545ms
    const now = window.performance.now();

    // 1. SEND MIDI START (System Real-Time)
    midiOut.send([0xFA]); 
    log("EP-40 Clock Started");

    // 2. SCHEDULE THE HITS (Assuming 4/4 Time, 1 Bar)
    // Pad 1 (Kick) = MIDI Note 36 | Pad 2 (Snare) = MIDI Note 37
    
    // Beat 1: Kick
    sendNote(36, 110, now + (msPerBeat * 0));
    // Beat 2: Snare
    sendNote(37, 100, now + (msPerBeat * 1));
    // Beat 3: Kick
    sendNote(36, 110, now + (msPerBeat * 2));
    // Beat 4: Snare
    sendNote(37, 100, now + (msPerBeat * 3));

    // 3. SEND MIDI STOP after 1 bar
    setTimeout(() => {
        midiOut.send([0xFC]);
        log("Auto-Program Complete.");
    }, msPerBeat * 4);
};

        // MACRO FADER (CC 74 is usually Filter Cutoff)
        document.getElementById('macro-fader').oninput = (e) => {
            if (midiOut) midiOut.send([176, 74, e.target.value]);
        };

        // PANIC
        document.getElementById('panic-btn').onclick = () => {
            if (midiOut) for(let i=0; i<16; i++) midiOut.send([176, 123, 0]); // All notes off
            log("Panic: All notes killed.");
        };
    </script>
</body>
</html>
