<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP-DC-OXO // DRUM COMPUTER</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #d8d4c9 0%, #b1b1b1 33%, #c9b98d 66%, #a1a1a1 100%);
            --accent: #ff3e00; --text: #1a1a1a; --lcd-bg: #080a08; 
            --lcd-text: #39ff14; --border: #8e8e8e; --panel-bg: rgba(255, 255, 255, 0.4);
            --shadow: rgba(0,0,0,0.3); --input-bg: #fff;
        }

        /* DARK MODE OVERRIDE */
        body.dark-mode {
            --bg: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            --text: #e0e0e0; --border: #444; --panel-bg: rgba(40, 40, 40, 0.8);
            --shadow: rgba(0,0,0,0.8); --input-bg: #121212;
        }

        /* HARDWARE THEMES */
        body.theme-40 { --accent: #ff3e00; --lcd-text: #008f11; }
        body.theme-133 { --accent: #ff3e00; --lcd-text: #ff4500; }
        body.theme-1320 { --accent: #9b111e; --lcd-text: #f3e5ab; }

        body {
            background: var(--bg); background-attachment: fixed; color: var(--text);
            font-family: 'IBM Plex Mono', monospace; display: flex; flex-direction: column; 
            align-items: center; padding: 40px 20px; margin: 0; transition: all 0.4s ease;
        }

        .chassis {
            background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px;
            padding: 30px; width: 100%; max-width: 520px; box-shadow: 20px 20px 60px var(--shadow);
            backdrop-filter: blur(10px);
        }

        h1 {
            background: var(--text); color: var(--lcd-bg); padding: 15px; font-size: 1.1rem; 
            text-align: center; letter-spacing: 6px; margin: -30px -30px 25px -30px; 
            text-transform: uppercase; font-weight: 900; border-radius: 10px 10px 0 0;
        }

        .lcd-display {
            background: var(--lcd-bg); color: var(--lcd-text); padding: 18px; border-radius: 4px; 
            font-size: 0.85rem; font-weight: bold; margin-bottom: 25px; border: 4px solid #222;
            height: 40px; box-shadow: inset 0 0 20px #000; text-shadow: 0 0 5px var(--lcd-text);
        }

        .ep-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .pad-btn { 
            background: var(--panel-bg); border: 2px solid var(--border); height: 75px; 
            border-radius: 8px; cursor: pointer; position: relative; transition: 0.1s;
            box-shadow: 0 5px 0 rgba(0,0,0,0.15); color: var(--text);
        }
        .pad-btn.active-pad { border-color: var(--accent); background: var(--accent) !important; color: white; box-shadow: 0 6px 0 rgba(0,0,0,0.25); }

        .legend-tag { position: absolute; top: 10px; right: 12px; font-weight: 900; font-size: 0.9rem; }
        
        .pad-btn-sq::before {
            content: ''; position: absolute; top: 11%; left: 11%; width: 14.4%; height: 14.4%;
            background: var(--accent); border-radius: 1px;
        }
        .active-pad.pad-btn-sq::before { background: white; }

        .editor-panel { background: var(--panel-bg); border: 2px solid var(--accent); padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .step-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-top: 15px; }
        .step-box { aspect-ratio: 1/1; background: rgba(0,0,0,0.1); border: 2px solid var(--text); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; font-weight: 900; border-radius: 4px; color: var(--text); }
        .step-box.on-x { background: var(--accent); color: white; border-color: var(--accent); }
        .step-box.off { opacity: 0.2; }

        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .config-sub-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 15px; margin-bottom: 20px; align-items: end; }
        
        label { font-size: 0.6rem; font-weight: bold; text-transform: uppercase; margin-bottom: 8px; display: block; }
        select, input { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); font-family: inherit; border-radius: 4px; font-weight: bold; }

        .transport button { background: var(--text); color: var(--lcd-bg); border: none; padding: 18px; font-weight: 900; cursor: pointer; border-radius: 6px; flex: 1; text-transform: uppercase; border-bottom: 5px solid rgba(0,0,0,0.4); }
        button.primary { background: var(--accent); color: white; }
        button.toggle-btn { background: var(--panel-bg); color: var(--text); border: 1px solid var(--border); padding: 10px; font-size: 0.55rem; }
        button.toggle-on { background: var(--lcd-text); color: #000; border-color: var(--lcd-text); }
    </style>
</head>
<body id="main-body">

<div class="chassis">
    <h1>EP-DC-OXO</h1>
    <div class="lcd-display" id="log">READY // SELECT PAD TO EDIT</div>

    <div class="panel" style="margin-bottom: 25px;">
        <button onclick="initMIDI()" class="primary" id="init-btn" style="width:100%;">INITIALIZE CONNECTION</button>
    </div>

    <div class="config-row">
        <div><label>TEMPO</label><input type="number" id="tempo" value="120"></div>
        <div><label>LENGTH</label>
            <select id="global-bars">
                <option value="1">1 Bar</option><option value="2">2 Bars</option>
                <option value="4">4 Bars</option><option value="8">8 Bars</option>
                <option value="16">16 Bars</option>
            </select>
        </div>
    </div>

    <div class="config-sub-row">
        <div><label>SWING</label><input type="range" id="swing-slider" min="0" max="75" value="0"></div>
        <div><label>FEEL</label><button id="human-btn" onclick="toggleHuman()" class="toggle-btn">HUMAN: OFF</button></div>
        <div><label>VIEW</label><button onclick="toggleDarkMode()" class="toggle-btn" id="dark-toggle">NIGHT: OFF</button></div>
    </div>

    <div class="ep-grid" id="pad-grid"></div>

    <div class="editor-panel" id="editor" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <strong id="editor-title">PAD</strong>
            <button onclick="clearCurrentPad()" style="width:auto; padding:5px 12px; font-size:0.55rem; background:#444; color:white; border-radius: 4px;">CLEAR GRID</button>
        </div>
        <div class="config-row" style="grid-template-columns: 1fr 2fr; margin-bottom: 10px;">
            <div><label>STEPS</label><select id="step-select" onchange="updateStepCount(this.value)"><option value="8">8</option><option value="16" selected>16</option><option value="32">32</option></select></div>
            <div><label>OXO PRESETS</label><select id="preset-select" onchange="applyPreset(this.value)"></select></div>
        </div>
        <div class="step-container" id="step-ui"></div>
    </div>

    <div class="transport" style="display:flex; gap:15px;">
        <button onclick="startSequencer()" class="primary" style="flex: 2;">INJECT OXO</button>
        <button onclick="stopSequencer()" style="background: #333; flex: 1; color: white;">STOP</button>
    </div>
</div>

<script>
    let midiOut = null; let timer = null; let selectedPad = 0; let humanize = false;
    const legends = { 6:'7', 7:'8', 8:'9', 3:'4', 4:'5', 5:'6', 0:'1', 1:'2', 2:'3', 9:'', 10:'0', 11:'ENTER' };
    const visualOrder = [6, 7, 8, 3, 4, 5, 0, 1, 2, 9, 10, 11];
    const padNotes = [36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47];
    const oxoPresets = ["CUSTOM OXO", "XOOO XOOO XOOO XOOO", "OOOO XOOO OOOO XOOO", "XOXO XOXO XOXO XOXO", "XOXX OOXY XOXX OOXZ", "XOOX OXOO XOOX OXOO", "XOZY XOZY XOZY XOZY"];
    let sequencerData = Array.from({length: 12}, () => ({ steps: 16, data: Array(32).fill('O') }));

    const ps = document.getElementById('preset-select');
    oxoPresets.forEach((p, i) => { let o = document.createElement('option'); o.value = i; o.innerText = p; ps.appendChild(o); });

    const gridEl = document.getElementById('pad-grid');
    visualOrder.forEach(idx => {
        const btn = document.createElement('div');
        btn.className = 'pad-btn' + (idx === 9 ? ' pad-btn-sq' : '');
        btn.id = `btn-${idx}`;
        btn.innerHTML = `<div class="legend-tag">${legends[idx]}</div>`;
        btn.onclick = () => selectPad(idx); gridEl.appendChild(btn);
    });

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('dark-toggle').innerText = `NIGHT: ${isDark ? 'ON' : 'OFF'}`;
        document.getElementById('dark-toggle').classList.toggle('toggle-on', isDark);
    }

    async function initMIDI() {
        const midi = await navigator.requestMIDIAccess();
        midiOut = Array.from(midi.outputs.values()).find(o => o.name.toLowerCase().includes("ep") || o.name.toLowerCase().includes("sample"));
        if (midiOut) {
            const name = midiOut.name.toLowerCase();
            document.body.classList.remove('theme-40', 'theme-133', 'theme-1320');
            document.body.classList.add(name.includes("1320") ? 'theme-1320' : name.includes("133") ? 'theme-133' : 'theme-40');
            document.getElementById('init-btn').innerText = "DEVICE SYNCED";
            log("ONLINE // " + midiOut.name.toUpperCase());
        }
    }

    function toggleHuman() { humanize = !humanize; document.getElementById('human-btn').classList.toggle('toggle-on', humanize); document.getElementById('human-btn').innerText = `HUMAN: ${humanize ? 'ON' : 'OFF'}`; }

    function selectPad(idx) {
        selectedPad = idx;
        document.querySelectorAll('.pad-btn').forEach(b => b.classList.remove('active-pad'));
        document.getElementById(`btn-${idx}`).classList.add('active-pad');
        document.getElementById('editor').style.display = 'block';
        document.getElementById('preset-select').selectedIndex = 0;
        let leg = idx === 9 ? 'â– ' : legends[idx];
        document.getElementById('editor-title').innerText = `PAD: ${leg}`;
        renderSteps();
    }

    function renderSteps() {
        const container = document.getElementById('step-ui'); container.innerHTML = '';
        for (let i = 0; i < sequencerData[selectedPad].steps; i++) {
            const step = document.createElement('div'); const val = sequencerData[selectedPad].data[i];
            step.className = `step-box ${val !== 'O' ? 'on-' + val.toLowerCase() : 'off'}`;
            step.innerText = val;
            step.onclick = () => { const cycle = ['O', 'X', 'Y', 'Z']; sequencerData[selectedPad].data[i] = cycle[(cycle.indexOf(val) + 1) % cycle.length]; renderSteps(); };
            container.appendChild(step);
        }
    }

    function applyPreset(idx) { if (idx == 0) return; const pat = oxoPresets[idx].replace(/\s/g, ''); for(let i=0; i<32; i++) sequencerData[selectedPad].data[i] = pat[i % pat.length] || 'O'; renderSteps(); }
    function updateStepCount(v) { sequencerData[selectedPad].steps = v; renderSteps(); }
    function clearCurrentPad() { sequencerData[selectedPad].data.fill('O'); renderSteps(); }
    function log(m) { const l = document.getElementById('log'); l.innerHTML = `> ${m}`; }

    function startSequencer() {
        if (!midiOut) return log("ERR: INITIALIZE FIRST");
        stopSequencer();
        const bpm = parseInt(document.getElementById('tempo').value); const bars = parseInt(document.getElementById('global-bars').value); const swing = parseInt(document.getElementById('swing-slider').value);
        const stepTime = (60000 / bpm) / 4; let currentStep = 0; const totalSteps = bars * 16;
        midiOut.send([0xFA]);
        timer = setInterval(() => {
            if (currentStep >= totalSteps) { stopSequencer(); log("COMPLETE"); return; }
            const delay = (currentStep % 2 !== 0 ? (stepTime * (swing / 100)) : 0) + (humanize ? Math.random() * 20 : 0);
            for (let p = 0; p < 12; p++) {
                const char = sequencerData[p].data[currentStep % sequencerData[p].steps];
                if (char !== 'O') {
                    const vel = char === 'X' ? 120 : char === 'Y' ? 85 : 50;
                    setTimeout(() => { midiOut.send([144, padNotes[p], vel]); setTimeout(() => midiOut.send([128, padNotes[p], 0]), 100); }, delay);
                }
            }
            currentStep++;
        }, stepTime);
    }

    function stopSequencer() { clearInterval(timer); timer = null; if (midiOut) { midiOut.send([0xFC]); for(let i=0; i<16; i++) midiOut.send([176, 123, 0]); } log("HALTED."); }
    selectPad(9); 
</script>
</body>
</html>
