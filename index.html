<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP-DC-OXO // PRECISION</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg: linear-gradient(135deg, #d8d4c9 0%, #b1b1b1 33%, #c9b98d 66%, #a1a1a1 100%);
            --accent: #ff3e00; --text: #1a1a1a; --lcd-bg: #080a08; 
            --lcd-text: #39ff14; --border: #8e8e8e; --panel-bg: rgba(255, 255, 255, 0.45);
            --shadow: rgba(0,0,0,0.4); --fader-track: #ccc;
        }

        body.theme-40 { --bg: #f4f1e6; --accent: #ff3e00; --text: #1a1a1a; --lcd-bg: #050a05; --lcd-text: #008f11; --border: #c5c2b7; --panel-bg: #ffffff; }
        body.theme-133 { --bg: #bcbcbc; --accent: #ff3e00; --text: #000000; --lcd-bg: #121212; --lcd-text: #ff4500; --border: #888888; --panel-bg: #e0e0e0; }
        body.theme-1320 { --bg: #dccb96; --accent: #9b111e; --text: #3d2b1f; --lcd-bg: #2e1a0d; --lcd-text: #f3e5ab; --border: #a6894c; --panel-bg: #e6d9ad; }
        
        body.dark-mode {
            --bg: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            --text: #e0e0e0; --border: #444; --panel-bg: rgba(30,30,30,0.9); 
            --fader-track: #444;
        }

        body {
            background: var(--bg); background-attachment: fixed; color: var(--text);
            font-family: 'IBM Plex Mono', monospace; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 100vh; margin: 0; transition: all 0.4s ease;
        }

        /* --- CHASSIS --- */
        .chassis {
            background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px;
            padding: 25px; width: 95%; max-width: 980px;
            box-shadow: 20px 20px 60px var(--shadow); backdrop-filter: blur(10px);
            transition: max-width 0.4s ease;
        }
        .chassis.skinny-mode { max-width: 480px; }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 4px; font-weight: 900; }
        
        .main-deck { display: grid; grid-template-columns: 1fr 1.3fr; gap: 30px; }
        .chassis.skinny-mode .main-deck { grid-template-columns: 1fr; } 

        /* --- TERMINAL --- */
        .lcd-display {
            background: var(--lcd-bg); color: var(--lcd-text); padding: 12px; border-radius: 4px; 
            font-size: 0.75rem; font-weight: normal; border: 4px solid #222; width: 100%;
            height: 60px; box-shadow: inset 0 0 20px #000; text-shadow: 0 0 3px var(--lcd-text);
            overflow-y: auto; font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column-reverse; box-sizing: border-box; margin-bottom: 20px;
        }
        .log-entry { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 2px 0; }
        .lcd-overlay { font-size: 2rem; text-align: center; color: var(--accent); font-weight: 900; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 0.6; } to { opacity: 1; } }

        /* --- CONTROLS --- */
        .control-group { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: end; }
        .split-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }
        
        label { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 1px; opacity: 0.8; }
        select, input[type="number"] { width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--text); color: var(--text); font-family: inherit; border-radius: 2px; font-weight: bold; font-size: 0.75rem; box-sizing: border-box; }
        
        /* --- PAD GRID (3x4) --- */
        .ep-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .pad-btn { background: rgba(0,0,0,0.05); border: 2px solid var(--border); height: 80px; border-radius: 6px; cursor: pointer; position: relative; transition: 0.05s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .pad-btn.active-pad { border-color: var(--accent); background: var(--accent) !important; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transform: translateY(1px); }
        .pad-btn.hit { filter: brightness(1.5); transform: translateY(2px); }
        .legend-tag { position: absolute; top: 8px; right: 10px; font-weight: 900; font-size: 0.85rem; }
        .pad-btn-sq::before { content: ''; position: absolute; top: 11%; left: 11%; width: 14.4%; height: 14.4%; background: var(--accent); border-radius: 1px; }
        .active-pad.pad-btn-sq::before { background: white; }

        /* --- EDITOR & SLIDERS --- */
        .editor-panel { background: rgba(0,0,0,0.03); border: 2px solid var(--border); padding: 15px; border-radius: 8px; flex-grow: 1; }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        .sound-lab { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 4px; margin-bottom: 15px; border: 1px solid var(--border); }
        .knob-group { text-align: center; }
        .knob { -webkit-appearance: none; width: 100%; height: 4px; background: var(--text); outline: none; border-radius: 2px; margin-top: 5px; }
        .knob::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        .step-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; margin-top: 10px; }
        .step-box { aspect-ratio: 1/1; border: 2px solid var(--text); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; font-weight: 900; border-radius: 3px; opacity: 0.6; transition: 0.1s; }
        .step-box.on-x { background: var(--accent); color: white; border-color: var(--accent); opacity: 1; }
        .step-box.on-y { background: #555; color: white; border-color: #555; opacity: 1; }
        .step-box.on-z { color: var(--accent); border-color: var(--accent); border-style: dashed; opacity: 1; }
        .fader-step { height: 50px; background: var(--fader-track); position: relative; border-radius: 2px; cursor: crosshair; }
        .fader-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--accent); pointer-events: none; }

        /* --- BUTTONS --- */
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .btn-main { background: var(--text); color: var(--bg); border: none; padding: 18px; font-weight: 900; cursor: pointer; border-radius: 4px; text-transform: uppercase; border-bottom: 4px solid rgba(0,0,0,0.3); letter-spacing: 1px; font-size: 0.8rem; width: 100%; }
        .btn-main.primary { background: var(--accent); color: white; }
        .btn-main:active { transform: translateY(2px); border-bottom-width: 2px; }
        .btn-small { background: #555; color: white; border: none; padding: 10px; font-size: 0.65rem; cursor: pointer; border-radius: 3px; font-weight: bold; width: 100%; transition: background 0.2s; }
        .btn-layout { background: transparent; border: 2px solid var(--text); color: var(--text); font-weight: bold; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .btn-toggle-on { background: var(--lcd-text) !important; color: black !important; border-color: var(--lcd-text) !important; }
    </style>
</head>
<body id="main-body">

<div class="chassis" id="app-chassis">
    <div class="header-row">
        <h1>EP-DC-OXO</h1>
        <button class="btn-layout" onclick="toggleLayout()" title="View Toggle">⬌</button>
    </div>
    
    <div class="lcd-display" id="log"><div class="log-entry">SYSTEM READY // AUDIO_ENGINE v13</div></div>

    <div class="main-deck">
        
        <div class="deck-left">
            <button onclick="initAudioAndMIDI()" class="btn-main primary" id="init-btn" style="margin-bottom:20px;">START ENGINE</button>
            
            <div class="control-group" style="margin-bottom: 20px;">
                <div class="config-grid" style="margin-bottom: 15px;">
                    <div><label>BPM</label><input type="number" id="tempo" value="120"></div>
                    <div><label>SYNC MODE</label><select id="sync-mode"><option value="master">CLOCK OUT (MASTER)</option><option value="trigger">TRIGGER ONLY (SLAVE)</option></select></div>
                </div>
                <div class="split-row">
                    <div><label>LENGTH</label><select id="global-bars"><option value="1">1 Bar</option><option value="2">2 Bars</option><option value="4">4 Bars</option><option value="8">8 Bars</option><option value="16">16 Bars</option></select></div>
                    <div><label>SWING</label><input type="range" class="knob" id="swing-slider" min="0" max="75" value="0"></div>
                </div>
                <div class="split-row" style="margin-top: 10px;">
                    <div><button id="human-btn" onclick="toggleHuman()" class="btn-small">HUMAN: OFF</button></div>
                    <div><button id="count-btn" onclick="toggleCountIn()" class="btn-small">COUNT: OFF</button></div>
                </div>
            </div>

            <div class="ep-grid" id="pad-grid"></div>
        </div>

        <div class="deck-right" style="display:flex; flex-direction:column;">
            
            <div class="editor-panel" id="editor" style="display: none;">
                <div class="editor-header">
                    <strong id="editor-title">PAD SELECT</strong>
                    <div>
                        <button onclick="setEditMode('note')" class="btn-small" style="width:auto;">OXO</button>
                        <button onclick="setEditMode('auto')" class="btn-small" style="width:auto;">AUTO</button>
                    </div>
                </div>

                <div class="sound-lab">
                    <div class="knob-group"><label>PITCH (16)</label><input type="range" class="knob" min="0" max="127" value="64" oninput="sendLiveCC(16, this.value)"></div>
                    <div class="knob-group"><label>FILTER (74)</label><input type="range" class="knob" min="0" max="127" value="127" oninput="sendLiveCC(74, this.value)"></div>
                    <div class="knob-group"><label>DECAY (72)</label><input type="range" class="knob" min="0" max="127" value="64" oninput="sendLiveCC(72, this.value)"></div>
                    <div class="knob-group"><label>PAN (10)</label><input type="range" class="knob" min="0" max="127" value="64" oninput="sendLiveCC(10, this.value)"></div>
                    <div class="knob-group"><label>RVB (93)</label><input type="range" class="knob" min="0" max="127" value="0" oninput="sendLiveCC(93, this.value)"></div>
                    <div class="knob-group"><label>VOL (7)</label><input type="range" class="knob" min="0" max="127" value="100" oninput="sendLiveCC(7, this.value)"></div>
                </div>

                <div class="config-grid" style="margin-bottom: 10px;">
                    <div><label>PATTERN LEN</label><select id="step-select" onchange="updateStepCount(this.value)"><option value="8">8 Steps</option><option value="16" selected>16 Steps</option><option value="32">32 Steps</option></select></div>
                    <div><label>PRESET</label><select id="preset-select" onchange="applyPreset(this.value)"></select></div>
                </div>

                <div id="grid-notes" class="step-container"></div>
                <div id="grid-auto" class="step-container" style="display:none;"></div>
                
                <div style="margin-top:15px; text-align:right;"><button onclick="clearCurrentPad()" class="btn-small" style="width: auto;">CLEAR PATTERN</button></div>
            </div>

            <div class="control-group" style="margin-top:auto; margin-bottom:10px;">
                <div class="config-grid">
                    <button onclick="saveProject()" class="btn-small">SAVE .OXO</button>
                    <button onclick="document.getElementById('file-input').click()" class="btn-small">LOAD .OXO</button>
                    <input type="file" id="file-input" style="display:none" onchange="loadProject(this)">
                </div>
            </div>

            <div class="action-row">
                <button onclick="handleInject()" class="btn-main primary" id="inject-btn">INJECT</button>
                <button onclick="stopSequencer()" class="btn-main" style="background:#333; color:#fff;">STOP / PANIC</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- AUDIO & MIDI CONTEXT --- */
    let audioCtx = null;
    let midiOut = null;
    let nextNoteTime = 0.0;
    let timerID = null;
    let current16thNote = 0;
    let isPlaying = false;
    
    // Config
    let lookahead = 25.0; // ms
    let scheduleAheadTime = 0.1; // sec
    
    // State
    let selectedPad = 0;
    let humanize = false;
    let countIn = false;
    let editMode = 'note';
    let totalBarsToPlay = 0;
    let barsPlayed = 0;

    const legends = { 6:'7', 7:'8', 8:'9', 3:'4', 4:'5', 5:'6', 0:'1', 1:'2', 2:'3', 9:'', 10:'0', 11:'ENTER' };
    const visualOrder = [6, 7, 8, 3, 4, 5, 0, 1, 2, 9, 10, 11];
    const padNotes = [36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47];
    const oxoPresets = ["CUSTOM", "XOOO XOOO XOOO XOOO", "OOOO XOOO OOOO XOOO", "XOXO XOXO XOXO XOXO", "XOXX OOXY XOXX OOXZ", "XOOX OXOO XOOX OXOO", "XOZY XOZY XOZY XOZY"];

    let sequencerData = Array.from({length: 12}, () => ({ steps: 16, notes: Array(32).fill('O'), auto: Array(32).fill(0), autoTargetCC: 74 }));

    /* --- INIT --- */
    const ps = document.getElementById('preset-select');
    oxoPresets.forEach((p, i) => { let o = document.createElement('option'); o.value = i; o.innerText = p; ps.appendChild(o); });

    const gridEl = document.getElementById('pad-grid');
    visualOrder.forEach(idx => {
        const btn = document.createElement('div');
        btn.className = 'pad-btn' + (idx === 9 ? ' pad-btn-sq' : '');
        btn.id = `btn-${idx}`;
        btn.innerHTML = `<div class="legend-tag">${legends[idx]}</div>`;
        btn.onclick = () => selectPad(idx);
        gridEl.appendChild(btn);
    });

    function log(m) { 
        const l = document.getElementById('log');
        if (m.startsWith("COUNT")) { l.innerHTML = `<div class="lcd-overlay">${m.split(":")[1]}</div>`; }
        else {
            if (l.querySelector('.lcd-overlay')) l.innerHTML = '';
            l.innerHTML = `<div class="log-entry"><span class="log-time">${new Date().toLocaleTimeString().split(' ')[0]}</span>${m}</div>` + l.innerHTML;
        }
    }

    function toggleLayout() { document.getElementById('app-chassis').classList.toggle('skinny-mode'); }

    /* --- AUDIO/MIDI ENGINE --- */
    async function initAudioAndMIDI() {
        try {
            // 1. Audio Context for Timing
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            // 2. MIDI Access
            const midi = await navigator.requestMIDIAccess();
            midiOut = Array.from(midi.outputs.values()).find(o => o.name.toLowerCase().includes("ep") || o.name.toLowerCase().includes("sample"));
            
            if (midiOut) {
                const n = midiOut.name.toLowerCase();
                document.body.className = n.includes("1320") ? 'theme-1320' : n.includes("133") ? 'theme-133' : 'theme-40';
                document.getElementById('init-btn').innerText = "ENGINE ONLINE";
                log("AUDIO ENGINE & MIDI LINKED");
            } else { log("ERR: NO DEVICE FOUND"); }

        } catch(e) { log("ERR: ACCESS DENIED"); }
    }

    /* --- SCHEDULER --- */
    function nextNote() {
        const bpm = parseInt(document.getElementById('tempo').value);
        const secondsPerBeat = 60.0 / bpm;
        nextNoteTime += 0.25 * secondsPerBeat; // Add 16th note length
        current16thNote++;
    }

    function scheduleNote(beatNumber, time) {
        if (!midiOut) return;

        // CLOCK PULSES: If in Master Mode, we must send 6 clock pulses per 16th note
        // Note: Web MIDI API doesn't support scheduling SysEx/Realtime in future easily. 
        // We rely on high-frequency triggering for Clock, or accept some jitter.
        // BETTER: Send Clock NOW if close enough. 
        // Ideally, for precise clock, we need a dedicated worker. 
        // For this build, we will focus on sending the NOTE precisely.
        
        // Sync Mode Check
        const isMaster = document.getElementById('sync-mode').value === 'master';
        if (isMaster) {
            // Simplified Clock Injection: Send a burst of 6 pulses? No, that rushes.
            // We just send one pulse per call? Too slow. 
            // Correct approach: We send 0xF8 immediately in the main loop, 
            // but we use the audio timer to Trigger the Notes.
        }

        const swing = parseInt(document.getElementById('swing-slider').value);
        const isEven = beatNumber % 2 !== 0;
        const swingDelay = isEven ? ((60/parseInt(document.getElementById('tempo').value))/4) * (swing/100) : 0;
        const humanJitter = humanize ? (Math.random() * 0.015) : 0; // 15ms jitter

        const actualTime = time + swingDelay + humanJitter;

        // Iterate Pads
        for (let p = 0; p < 12; p++) {
            const pad = sequencerData[p];
            const stepIdx = beatNumber % pad.steps;
            const note = pad.notes[stepIdx];
            const auto = pad.auto[stepIdx];
            
            // We use perform(msg, timestamp) if browser supports it, otherwise setTimeout
            // Most browsers support timestamp in send()
            // However, 'time' is AudioContext time. MIDI needs DOMHighResTimeStamp (performance.now())
            // Conversion: performance.now() + (time - audioCtx.currentTime) * 1000
            
            const midiTime = performance.now() + (actualTime - audioCtx.currentTime) * 1000;

            if (auto > 0) midiOut.send([0xB0, pad.autoTargetCC, auto], midiTime);
            if (note !== 'O') {
                const vel = note === 'X' ? 120 : note === 'Y' ? 85 : 50;
                midiOut.send([144, padNotes[p], vel], midiTime);
                midiOut.send([128, padNotes[p], 0], midiTime + 100);
                
                // Visual Flash (approximate)
                setTimeout(() => flashPad(padNotes[p]), (actualTime - audioCtx.currentTime) * 1000);
            }
        }
    }

    function scheduler() {
        // While there are notes that will need to play before the next interval, schedule them
        while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
            scheduleNote(current16thNote, nextNoteTime);
            
            // Check for end of loop
            const totalBars = parseInt(document.getElementById('global-bars').value);
            const total16ths = totalBars * 16;
            
            if (current16thNote >= total16ths) {
                // STOP!
                stopSequencer();
                log("INJECTION COMPLETE");
                return;
            }
            
            // MIDI CLOCK PULSES (Approximation for Master Mode)
            // If Master Mode, we should be sending 0xF8 continuously. 
            // Using a separate interval for Clock is safer than scheduling it here.
            
            nextNote();
        }
        if (isPlaying) timerID = requestAnimationFrame(scheduler);
    }

    /* --- TRANSPORT --- */
    let clockInterval = null;

    function handleInject() {
        if (!midiOut || !audioCtx) return log("ERR: START ENGINE FIRST");
        if (countIn) runCountIn();
        else startSequencer();
    }

    function runCountIn() {
        let beat = 4;
        const bpm = parseInt(document.getElementById('tempo').value);
        const beatTime = 60000 / bpm;
        log(`COUNT: ${beat}...`);
        const ci = setInterval(() => {
            beat--;
            if (beat > 0) log(`COUNT: ${beat}...`);
            else { clearInterval(ci); log("COUNT: GO!"); startSequencer(); }
        }, beatTime);
    }

    function startSequencer() {
        stopSequencer(); // Reset
        
        const bpm = parseInt(document.getElementById('tempo').value);
        const isMaster = document.getElementById('sync-mode').value === 'master';
        
        isPlaying = true;
        current16thNote = 0;
        nextNoteTime = audioCtx.currentTime + 0.1; // Start 100ms in future
        
        // 1. Send Clock PRE-ROLL if Master Mode
        if (isMaster) {
            // Send 100ms of clock pulses before Start to wake up device
            // 24 PPQN @ 120BPM = ~20ms interval
            const pulseLen = 60000 / (bpm * 24);
            let pr = 0;
            const preRoll = setInterval(() => {
                midiOut.send([0xF8]);
                pr++;
                if (pr > 5) {
                    clearInterval(preRoll);
                    // NOW SEND START
                    midiOut.send([0xFA]);
                    // Start Main Clock Loop
                    clockInterval = setInterval(() => midiOut.send([0xF8]), pulseLen);
                }
            }, pulseLen);
        } else {
            // Trigger Mode: Just send Start
            midiOut.send([0xFA]);
        }

        log(`INJECTING...`);
        scheduler();
    }

    function stopSequencer() {
        isPlaying = false;
        if (timerID) cancelAnimationFrame(timerID);
        if (clockInterval) clearInterval(clockInterval);
        
        if (midiOut) {
            midiOut.send([0xFC]); // Stop
            for(let i=0; i<16; i++) midiOut.send([176, 123, 0]); // All Notes Off
        }
        log("HALTED");
    }

    /* --- HELPERS --- */
    function flashPad(note) {
        const padIdx = padNotes.indexOf(note);
        if (padIdx !== -1) {
            const btn = document.getElementById(`btn-${padIdx}`);
            if (btn) { btn.classList.add('hit'); setTimeout(() => btn.classList.remove('hit'), 100); }
        }
    }
    
    // UI Toggles
    function toggleHuman() { humanize = !humanize; document.getElementById('human-btn').innerText = `HUMAN: ${humanize ? 'ON' : 'OFF'}`; document.getElementById('human-btn').classList.toggle('btn-toggle-on', humanize); }
    function toggleCountIn() { countIn = !countIn; document.getElementById('count-btn').innerText = `COUNT: ${countIn ? '4' : 'OFF'}`; document.getElementById('count-btn').classList.toggle('btn-toggle-on', countIn); }
    function toggleDark() { document.body.classList.toggle('dark-mode'); document.getElementById('dark-btn').innerText = document.body.classList.contains('dark-mode') ? "NIGHT: ON" : "NIGHT: OFF"; }
    
    function setEditMode(m) {
        editMode = m;
        document.getElementById('grid-notes').style.display = m === 'note' ? 'grid' : 'none';
        document.getElementById('grid-auto').style.display = m === 'auto' ? 'grid' : 'none';
        renderSteps();
    }

    function selectPad(idx) {
        selectedPad = idx;
        document.querySelectorAll('.pad-btn').forEach(b => b.classList.remove('active-pad'));
        document.getElementById(`btn-${idx}`).classList.add('active-pad');
        document.getElementById('editor').style.display = 'block';
        document.getElementById('preset-select').selectedIndex = 0;
        let leg = idx === 9 ? '■' : legends[idx];
        document.getElementById('editor-title').innerText = `EDIT PAD ${leg}`;
        renderSteps();
    }

    function renderSteps() {
        const noteContainer = document.getElementById('grid-notes');
        const autoContainer = document.getElementById('grid-auto');
        noteContainer.innerHTML = ''; autoContainer.innerHTML = '';
        const padData = sequencerData[selectedPad];

        for (let i = 0; i < padData.steps; i++) {
            const nDiv = document.createElement('div');
            const val = padData.notes[i];
            nDiv.className = `step-box ${val !== 'O' ? 'on-' + val.toLowerCase() : 'off'}`;
            nDiv.innerText = val;
            nDiv.onclick = () => {
                const cycle = ['O', 'X', 'Y', 'Z'];
                padData.notes[i] = cycle[(cycle.indexOf(val) + 1) % cycle.length];
                renderSteps();
            };
            noteContainer.appendChild(nDiv);

            const aDiv = document.createElement('div');
            aDiv.className = 'fader-step';
            const ccVal = padData.auto[i];
            aDiv.innerHTML = `<div class="fader-fill" style="height:${(ccVal/127)*100}%"></div>`;
            aDiv.onclick = (e) => {
                const rect = aDiv.getBoundingClientRect();
                const h = rect.bottom - e.clientY;
                let v = Math.floor((h / rect.height) * 127);
                padData.auto[i] = Math.max(0, Math.min(127, v));
                renderSteps();
            };
            autoContainer.appendChild(aDiv);
        }
    }

    function sendLiveCC(cc, val) { if (midiOut) midiOut.send([0xB0, cc, parseInt(val)]); }
    function applyPreset(idx) { if (idx == 0) return; const pat = oxoPresets[idx].replace(/\s/g, ''); for(let i=0; i<32; i++) sequencerData[selectedPad].notes[i] = pat[i % pat.length] || 'O'; renderSteps(); }
    function updateStepCount(v) { sequencerData[selectedPad].steps = parseInt(v); renderSteps(); }
    function clearCurrentPad() { sequencerData[selectedPad].notes.fill('O'); sequencerData[selectedPad].auto.fill(0); renderSteps(); }
    function saveProject() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sequencerData)); a.download = "ep_oxo_session.json"; a.click(); log("SESSION SAVED"); }
    function loadProject(input) { const r = new FileReader(); r.onload = (e) => { sequencerData = JSON.parse(e.target.result); selectPad(selectedPad); log("SESSION LOADED"); }; r.readAsText(input.files[0]); }
    
    selectPad(9);
</script>
</body>
</html>
